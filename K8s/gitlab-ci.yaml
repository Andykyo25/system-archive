stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  BUILD_TIME: ""

# æ¨¡æ¿å®šç¾©
.build_template: &build_template
  stage: build
  before_script:
    - export BUILD_TIME=$(date +'%Y-%m-%d-%H-%M')
    - echo "BUILD_TIME=$BUILD_TIME" > build.env
  artifacts:
    reports:
      dotenv: build.env
    expire_in: 1 week
    paths:
      - build.env

.test_template: &test_template
  stage: test
  allow_failure: true

.deploy_template: &deploy_template
  stage: deploy
  dependencies:
    - build

# é–‹ç™¼ç’°å¢ƒ (Merge Request è§¸ç™¼)
dev-build:
  <<: *build_template
  tags:
    - ws-dev-k8s-runner
  rules:
    - if: $CI_MERGE_REQUEST_LABELS == 'ws-k8s-dev' && $CI_PIPELINE_SOURCE == 'merge_request_event'
  script:
    - cd ./ws-dev-k8s-spring
    - bash build.sh ws-k8s-dev $BUILD_TIME
    - echo "âœ… K8s Dev å»ºç½®å®Œæˆ"

dev-sonar-check:
  <<: *test_template
  tags:
    - ws-sonar-qube-runner
  rules:
    - if: $CI_MERGE_REQUEST_LABELS == 'ws-k8s-dev' && $CI_PIPELINE_SOURCE == 'merge_request_event'
  image: 
    name: sonarsource/sonar-scanner-cli:5.0
    entrypoint: [""]
  variables:
    GIT_DEPTH: 0
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script: 
    - sonar-scanner
  needs:
    - dev-build

dev-deploy:
  <<: *deploy_template
  tags:
    - ws-dev-k8s-runner
  rules:
    - if: $CI_MERGE_REQUEST_LABELS == 'ws-k8s-dev' && $CI_PIPELINE_SOURCE == 'merge_request_event'
  script:
    - source build.env
    - cd ./ws-dev-k8s-spring
    - bash deploy.sh dev-k8s $BUILD_TIME
    - echo "âœ… K8s Dev éƒ¨ç½²å®Œæˆ"
  needs:
    - dev-build
    - dev-sonar-check

dev-test:
  stage: test
  tags:
    - ws-dev-k8s-runner
  rules:
    - if: $CI_MERGE_REQUEST_LABELS == 'ws-k8s-dev' && $CI_PIPELINE_SOURCE == 'merge_request_event'
  script:
    - cd ./ws-dev-k8s-spring
    - bash unit-test.sh dev-k8s
    - echo "âœ… é–‹ç™¼ç’°å¢ƒæ¸¬è©¦å®Œæˆ"
  needs:
    - dev-deploy

# ç’°å¢ƒé…ç½®æ˜ å°„
.env_config:
  - &sit_config
    env: "sit"
    runner: "aws-cloud-eks-mix-runner"
    folder: "aws-mix-sit-spring"
    build_param: "aws-cloud-eks-sit"
    deploy_param: "sit-eks"
  - &uat_config
    env: "uat"
    runner: "aws-cloud-eks-mix-runner"
    folder: "aws-mix-uat-spring"
    build_param: "aws-cloud-eks-uat"
    deploy_param: "uat-eks"
  - &demo_config
    env: "demo"
    runner: "aws-cloud-eks-mix-runner"
    folder: "aws-mix-demo-spring"
    build_param: "aws-cloud-eks-demo"
    deploy_param: "demo-eks"
  - &prd_config
    env: "prd"
    runner: "aws-cloud-eks-prd-runner"
    folder: "aws-prd-eks-spring"
    build_param: "sit"
    deploy_param: "sit-k8s"

# å‹•æ…‹ç”¢ç”Ÿç’°å¢ƒä»»å‹™çš„æ¨¡æ¿
.env_build_template: &env_build_template
  stage: build
  script:
    - echo "ðŸ—ï¸  å»ºç½®ç’°å¢ƒ: $ENV_NAME"
    - echo "æ¨™ç±¤: $CI_COMMIT_TAG"
    - cd ./$FOLDER_NAME
    - bash build.sh $BUILD_PARAM $CI_COMMIT_TAG
    - echo "âœ… $ENV_NAME å»ºç½®å®Œæˆ"

.env_deploy_template: &env_deploy_template
  stage: deploy
  script:
    - echo "ðŸš€ éƒ¨ç½²ç’°å¢ƒ: $ENV_NAME"
    - echo "æ¨™ç±¤: $CI_COMMIT_TAG"
    - cd ./$FOLDER_NAME
    - bash deploy.sh $DEPLOY_PARAM $CI_COMMIT_TAG
    - echo "âœ… $ENV_NAME éƒ¨ç½²å®Œæˆ"

.env_test_template: &env_test_template
  stage: test
  script:
    - echo "ðŸ§ª æ¸¬è©¦ç’°å¢ƒ: $ENV_NAME"
    - cd ./$FOLDER_NAME
    - bash unit-test.sh $DEPLOY_PARAM $CI_COMMIT_TAG
    - echo "âœ… $ENV_NAME æ¸¬è©¦å®Œæˆ"

# SIT ç’°å¢ƒ
sit-build:
  <<: *env_build_template
  tags:
    - aws-cloud-eks-mix-runner
  rules:
    - if: $CI_COMMIT_TAG_ENV == 'aws-eks-mix-sit'
  variables:
    ENV_NAME: "SIT"
    FOLDER_NAME: "aws-mix-sit-spring"
    BUILD_PARAM: "aws-cloud-eks-sit"

sit-deploy:
  <<: *env_deploy_template
  tags:
    - aws-cloud-eks-mix-runner
  rules:
    - if: $CI_COMMIT_TAG_ENV == 'aws-eks-mix-sit'
  variables:
    ENV_NAME: "SIT"
    FOLDER_NAME: "aws-mix-sit-spring"
    DEPLOY_PARAM: "sit-eks"
  needs:
    - sit-build

sit-test:
  <<: *env_test_template
  tags:
    - aws-cloud-eks-mix-runner
  rules:
    - if: $CI_COMMIT_TAG_ENV == 'aws-eks-mix-sit'
  variables:
    ENV_NAME: "SIT"
    FOLDER_NAME: "aws-mix-sit-spring"
    DEPLOY_PARAM: "sit-eks"
  needs:
    - sit-deploy

# UAT ç’°å¢ƒ
uat-build:
  <<: *env_build_template
  tags:
    - aws-cloud-eks-mix-runner
  rules:
    - if: $CI_COMMIT_TAG_ENV == 'aws-eks-mix-uat'
  variables:
    ENV_NAME: "UAT"
    FOLDER_NAME: "aws-mix-uat-spring"
    BUILD_PARAM: "aws-cloud-eks-uat"

uat-deploy:
  <<: *env_deploy_template
  tags:
    - aws-cloud-eks-mix-runner
  rules:
    - if: $CI_COMMIT_TAG_ENV == 'aws-eks-mix-uat'
  variables:
    ENV_NAME: "UAT"
    FOLDER_NAME: "aws-mix-uat-spring"
    DEPLOY_PARAM: "uat-eks"
  needs:
    - uat-build

uat-test:
  <<: *env_test_template
  tags:
    - aws-cloud-eks-mix-runner
  rules:
    - if: $CI_COMMIT_TAG_ENV == 'aws-eks-mix-uat'
  variables:
    ENV_NAME: "UAT"
    FOLDER_NAME: "aws-mix-uat-spring"
    DEPLOY_PARAM: "uat-eks"
  needs:
    - uat-deploy

# DEMO ç’°å¢ƒ
demo-build:
  <<: *env_build_template
  tags:
    - aws-cloud-eks-mix-runner
  rules:
    - if: $CI_COMMIT_TAG_ENV == 'aws-eks-mix-demo'
  variables:
    ENV_NAME: "DEMO"
    FOLDER_NAME: "aws-mix-demo-spring"
    BUILD_PARAM: "aws-cloud-eks-demo"

demo-deploy:
  <<: *env_deploy_template
  tags:
    - aws-cloud-eks-mix-runner
  rules:
    - if: $CI_COMMIT_TAG_ENV == 'aws-eks-mix-demo'
  variables:
    ENV_NAME: "DEMO"
    FOLDER_NAME: "aws-mix-demo-spring"
    DEPLOY_PARAM: "demo-eks"
  needs:
    - demo-build

demo-test:
  <<: *env_test_template
  tags:
    - aws-cloud-eks-mix-runner
  rules:
    - if: $CI_COMMIT_TAG_ENV == 'aws-eks-mix-demo'
  variables:
    ENV_NAME: "DEMO"
    FOLDER_NAME: "aws-mix-demo-spring"
    DEPLOY_PARAM: "demo-eks"
  needs:
    - demo-deploy

# ç”Ÿç”¢ç’°å¢ƒ
prd-build:
  <<: *env_build_template
  tags:
    - aws-cloud-eks-prd-runner
  rules:
    - if: $CI_COMMIT_TAG_ENV == 'aws-eks-prd'
  variables:
    ENV_NAME: "PRODUCTION"
    FOLDER_NAME: "aws-prd-eks-spring"
    BUILD_PARAM: "sit"

prd-deploy:
  <<: *env_deploy_template
  tags:
    - aws-cloud-eks-prd-runner
  rules:
    - if: $CI_COMMIT_TAG_ENV == 'aws-eks-prd'
  variables:
    ENV_NAME: "PRODUCTION"
    FOLDER_NAME: "aws-prd-eks-spring"
    DEPLOY_PARAM: "sit-k8s"
  needs:
    - prd-build

prd-test:
  <<: *env_test_template
  tags:
    - aws-cloud-eks-prd-runner
  rules:
    - if: $CI_COMMIT_TAG_ENV == 'aws-eks-prd'
  variables:
    ENV_NAME: "PRODUCTION"
    FOLDER_NAME: "aws-prd-eks-spring"
    DEPLOY_PARAM: "sit-k8s"
  needs:
    - prd-deploy