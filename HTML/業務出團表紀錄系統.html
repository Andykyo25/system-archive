<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>業務出團表紀錄系統 v3.1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        
        .table-container { 
            overflow-x: auto; 
            background: white; 
            border-radius: 0 0 8px 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            padding: 15px; 
            border-top: none;
        }

        /* 淺色系表頭 */
        .table thead th { 
            background-color: #e9ecef !important; 
            color: #495057; 
            font-weight: bold;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap; 
            vertical-align: middle; 
            text-align: center;
        }

        /* 重點動作欄位背景 */
        .th-highlight { background-color: #f3e5f5 !important; color: #6a1b9a; }
        .th-alert { background-color: #fff3e0 !important; color: #e65100; } 

        td { white-space: nowrap; vertical-align: middle; text-align: center; font-size: 0.95rem; }
        .text-left { text-align: left !important; }
        
        .status-v { color: #198754; font-weight: bold; background-color: #e8f5e9; padding: 2px 8px; border-radius: 4px; }
        
        /* 統計儀表板樣式 */
        .summary-panel {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-left: 5px solid #0d6efd;
        }
        .summary-item h5 { margin: 0; font-size: 0.9rem; color: #6c757d; }
        .summary-item .value { font-size: 1.5rem; font-weight: bold; color: #212529; }
        .text-success-dark { color: #198754 !important; }

        /* 日期標籤樣式 */
        .badge-date { font-size: 0.75rem; margin-left: 5px; }
        
        /* Tabs */
        .nav-tabs .nav-link { color: #495057; background-color: #e9ecef; margin-right: 2px; border-radius: 8px 8px 0 0; }
        .nav-tabs .nav-link.active { color: #0d6efd; background-color: white; border-top: 3px solid #0d6efd; font-weight: bold; }
        .nav-tabs { border-bottom: 1px solid #dee2e6; }

        /* 表單區塊樣式 (固定顯示) */
        .form-card {
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .form-card .card-header {
            background-color: white;
            border-bottom: 1px solid #eee;
            color: #0d6efd;
            font-size: 1.1rem;
        }
        .form-card .card-body {
            background-color: #ffffff;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <h2 class="mb-3 text-center text-secondary"><i class="fas fa-plane-departure"></i> 業務出團管理系統</h2>

    <!-- 操作區塊 -->
    <div class="row mb-3">
        <div class="col-md-12 text-end">
            <button class="btn btn-outline-success btn-sm" onclick="exportToCSV()"><i class="fas fa-file-excel"></i> 匯出 Excel</button>
            <label class="btn btn-outline-warning btn-sm btn-file">
                <i class="fas fa-file-upload"></i> 匯入 CSV <input type="file" id="csvFileInput" style="display: none;" onchange="importFromCSV(this)">
            </label>
            <button class="btn btn-outline-danger btn-sm" onclick="clearAllData()"><i class="fas fa-trash"></i> 清空</button>
        </div>
    </div>

    <!-- 輸入表單 (改為 Card 固定顯示，不再摺疊) -->
    <div class="card form-card">
        <div class="card-header">
            <strong><i class="fas fa-edit"></i> 資料輸入 / 編輯區</strong>
        </div>
        <div class="card-body">
            <form id="recordForm" onsubmit="event.preventDefault(); saveRecord();">
                <input type="hidden" id="editIndex" value="-1">
                <div class="row g-2">
                    <div class="col-md-2"><label class="form-label">出發日期</label><input type="date" class="form-control" id="f_date" required></div>
                    <div class="col-md-3"><label class="form-label">行程</label><input type="text" class="form-control" id="f_tour" placeholder="例如: 芬蘭破冰船15日" required></div>
                    <div class="col-md-2"><label class="form-label">客人代表</label><input type="text" class="form-control" id="f_name" required></div>
                    <div class="col-md-2"><label class="form-label">電話號碼</label><input type="text" class="form-control" id="f_phone"></div>
                    <div class="col-md-1"><label class="form-label">人數</label><input type="number" class="form-control" id="f_pax" min="1"></div>
                    <div class="col-md-2"><label class="form-label">訂編</label><input type="text" class="form-control" id="f_bookingId"></div>
                    
                    <div class="col-md-2"><label class="form-label">預估業績</label><input type="number" class="form-control" id="f_estRev"></div>
                    <div class="col-md-2"><label class="form-label">實際業績</label><input type="number" class="form-control" id="f_actRev"></div>
                    
                    <div class="col-md-2"><label class="form-label">合約狀態</label>
                        <select class="form-select" id="f_contract">
                            <option value="">未簽約</option>
                            <option value="線上">線上</option>
                            <option value="紙本">紙本</option>
                            <option value="PDF">PDF</option>
                        </select>
                    </div>
                    <div class="col-md-2"><label class="form-label text-primary">合約上傳</label>
                        <select class="form-select" id="f_contractUploaded"><option value="">否</option><option value="V">是 (V)</option></select>
                    </div>
                    <div class="col-md-2"><label class="form-label text-primary">寄出紙本</label>
                        <select class="form-select" id="f_paperSent"><option value="">否</option><option value="V">是 (V)</option></select>
                    </div>
                    <div class="col-md-2"><label class="form-label text-danger">行前通知</label>
                        <select class="form-select" id="f_preTripNotify"><option value="">否</option><option value="V">是 (V)</option></select>
                    </div>
                    
                    <div class="col-md-2"><label class="form-label">訂金</label><input type="number" class="form-control" id="f_deposit"></div>
                    <div class="col-md-2"><label class="form-label">尾款</label><input type="number" class="form-control" id="f_balance"></div>
                    <div class="col-md-2"><label class="form-label text-primary">繳帳單寄出</label>
                        <select class="form-select" id="f_billSent"><option value="">否</option><option value="V">是 (V)</option></select>
                    </div>

                    <div class="col-md-1"><label class="form-label">名單</label><select class="form-select" id="f_list"><option value="">-</option><option value="V">V</option></select></div>
                    <div class="col-md-1"><label class="form-label">分房</label><select class="form-select" id="f_room"><option value="">-</option><option value="V">V</option></select></div>
                    
                    <div class="col-md-4"><label class="form-label">備註</label><input type="text" class="form-control" id="f_note" placeholder="備註事項..."></div>
                </div>
                <div class="mt-3 text-center">
                    <button type="submit" class="btn btn-primary w-25">儲存紀錄</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">重置</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 月份分頁 Tabs -->
    <ul class="nav nav-tabs" id="monthTabs">
        <li class="nav-item"><a class="nav-link active" href="#">全部顯示</a></li>
    </ul>

    <!-- 統計儀表板 -->
    <div class="summary-panel" id="summaryPanel">
        <div class="summary-item text-center">
            <h5><i class="fas fa-users"></i> 總人數</h5>
            <div class="value" id="sumPax">0</div>
        </div>
        <div class="summary-item text-center">
            <h5><i class="fas fa-sack-dollar"></i> 預估業績總額</h5>
            <div class="value text-primary" id="sumEst">0</div>
        </div>
        <div class="summary-item text-center">
            <h5><i class="fas fa-coins"></i> 實際業績總額</h5>
            <div class="value text-success-dark" id="sumAct">0</div>
        </div>
    </div>

    <!-- 表格顯示區 -->
    <div class="table-container">
        <table class="table table-hover table-striped" id="dataTable">
            <thead>
                <tr>
                    <th style="width: 80px;">操作</th>
                    <th>出發日期</th>
                    <th>行程</th>
                    <th>客人代表</th>
                    <th>電話</th>
                    <th>人數</th>
                    <th>預估業績</th>
                    <th>實際業績</th>
                    <th>訂編</th>
                    <th>合約</th>
                    <th class="th-highlight">合約上傳</th>
                    <th class="th-highlight">寄出紙本</th>
                    <th class="th-alert">行前通知</th>
                    <th>訂金</th>
                    <th>尾款</th>
                    <th class="th-highlight">帳單寄出</th>
                    <th>名單</th>
                    <th>分房</th>
                    <th>備註</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- JS 插入資料 -->
            </tbody>
        </table>
    </div>
</div>

<script>
    // ★★★ 請將這裡換成你剛剛部署的 Google Apps Script 網址 ★★★
    const API_URL = "https://script.google.com/macros/s/AKfycbw4H6vytYgQN_9i-WD6vxqm9t5D9ofQ0PLcbEXRACPIvlggeTw-Y0YEfHz1uMlbfwrM3w/exec";
    
    // 定義欄位名稱
    const headers = [
        "出發日期", "行程", "客人代表", "電話號碼", "人數", 
        "預估業績", "實際業績", "訂編", "合約", "合約上傳", "寄出紙本", "行前通知",
        "訂金", "尾款", "繳帳單寄出", "名單", "分房", "備註"
    ];

    let salesData = []; // 現在資料從雲端抓，初始為空
    let currentTab = 'ALL'; 
    let isLoading = false; // 防止重複送出

    // 頁面載入時，從雲端讀取資料
    window.onload = function() {
        renderTable(); // 先顯示空表或讀取中
        loadFromCloud(); // 抓資料
    };

    // --- 雲端功能區 ---

    // 從 Google Sheet 讀取
    function loadFromCloud() {
        toggleLoading(true, "資料讀取中...");
        fetch(API_URL)
            .then(response => response.json())
            .then(data => {
                salesData = data;
                renderTabs();
                renderTable();
                toggleLoading(false);
            })
            .catch(error => {
                console.error('Error:', error);
                alert("讀取失敗，請檢查網路或 API 設定。");
                toggleLoading(false);
            });
    }

    // 儲存到 Google Sheet (全量覆蓋)
    function saveToCloud() {
        toggleLoading(true, "資料儲存中...");
        
        // 使用 fetch POST 發送資料
        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify(salesData) // 傳送整個陣列
        })
        .then(response => response.json())
        .then(result => {
            if(result.result === "success") {
                // 成功
                toggleLoading(false);
            } else {
                alert("儲存失敗：" + result.error);
                toggleLoading(false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("連線失敗，請檢查網路。");
            toggleLoading(false);
        });
    }

    // 切換讀取畫面遮罩
    function toggleLoading(show, msg) {
        isLoading = show;
        let loader = document.getElementById('loadingOverlay');
        if (!loader) {
            // 如果沒有遮罩元素，動態建立一個
            loader = document.createElement('div');
            loader.id = 'loadingOverlay';
            loader.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);z-index:9999;display:flex;justify-content:center;align-items:center;font-size:1.5rem;font-weight:bold;color:#0d6efd;";
            document.body.appendChild(loader);
        }
        loader.innerHTML = `<i class="fas fa-spinner fa-spin"></i> &nbsp; ${msg || '處理中...'}`;
        loader.style.display = show ? 'flex' : 'none';
    }

    // --- 以下為原本的邏輯，稍微修改儲存觸發點 ---

    function renderTabs() {
        const tabsContainer = document.getElementById('monthTabs');
        let months = new Set();
        salesData.forEach(row => {
            if(row.date) months.add(row.date.substring(0, 7));
        });
        let sortedMonths = Array.from(months).sort();

        let html = `<li class="nav-item"><button class="nav-link ${currentTab === 'ALL' ? 'active' : ''}" onclick="switchTab('ALL')">全部顯示</button></li>`;
        sortedMonths.forEach(m => {
            html += `<li class="nav-item"><button class="nav-link ${currentTab === m ? 'active' : ''}" onclick="switchTab('${m}')">${m}</button></li>`;
        });
        tabsContainer.innerHTML = html;
    }

    function switchTab(tab) {
        currentTab = tab;
        renderTabs(); 
        renderTable(); 
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        let totalPax = 0;
        let totalEst = 0;
        let totalAct = 0;
        const today = new Date();
        today.setHours(0,0,0,0);

        salesData.forEach((row, index) => {
            if (currentTab !== 'ALL') {
                if (!row.date || row.date.substring(0, 7) !== currentTab) return; 
            }

            totalPax += parseInt(row.pax || 0);
            totalEst += parseInt(row.estRev || 0);
            totalAct += parseInt(row.actRev || 0);

            let dateBadge = '';
            if (row.date) {
                const tripDate = new Date(row.date);
                const diffTime = tripDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                if (diffDays < 0) dateBadge = `<span class="badge bg-secondary badge-date">已出團</span>`;
                else if (diffDays <= 7) dateBadge = `<span class="badge bg-danger badge-date">剩${diffDays}天</span>`;
                else if (diffDays <= 30) dateBadge = `<span class="badge bg-warning text-dark badge-date">剩${diffDays}天</span>`;
            }

            let tr = document.createElement('tr');
            let btnTd = `
                <td>
                    <div class="btn-group-action">
                        <button class="btn btn-sm btn-outline-primary" onclick="editData(${index})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteData(${index})"><i class="fas fa-trash"></i></button>
                    </div>
                </td>`;
            
            // 確保每個欄位都有值，避免 undefined
            const safe = (val) => val || '';
            
            let dataTd = `
                <td>${safe(row.date)} ${dateBadge}</td>
                <td class="text-left fw-bold">${safe(row.tour)}</td>
                <td>${safe(row.name)}</td>
                <td>${safe(row.phone)}</td>
                <td>${safe(row.pax)}</td>
                <td>${formatMoney(row.estRev)}</td>
                <td>${formatMoney(row.actRev)}</td>
                <td>${safe(row.bookingId)}</td>
                <td>${safe(row.contract)}</td>
                <td><span class="${row.contractUploaded === 'V' ? 'status-v' : ''}">${safe(row.contractUploaded)}</span></td>
                <td><span class="${row.paperSent === 'V' ? 'status-v' : ''}">${safe(row.paperSent)}</span></td>
                <td><span class="${row.preTripNotify === 'V' ? 'status-v' : ''}">${safe(row.preTripNotify)}</span></td>
                <td>${formatMoney(row.deposit)}</td>
                <td>${formatMoney(row.balance)}</td>
                <td><span class="${row.billSent === 'V' ? 'status-v' : ''}">${safe(row.billSent)}</span></td>
                <td><span class="${row.list === 'V' ? 'status-v' : ''}">${safe(row.list)}</span></td>
                <td><span class="${row.room === 'V' ? 'status-v' : ''}">${safe(row.room)}</span></td>
                <td class="text-left text-muted" style="font-size:0.85rem;">${safe(row.note)}</td>
            `;

            tr.innerHTML = btnTd + dataTd;
            tbody.appendChild(tr);
        });

        document.getElementById('sumPax').textContent = totalPax;
        document.getElementById('sumEst').textContent = formatMoney(totalEst);
        document.getElementById('sumAct').textContent = formatMoney(totalAct);
    }

    function formatMoney(num) {
        if (!num) return '0';
        return parseInt(num).toLocaleString();
    }

    function saveRecord() {
        if (isLoading) return;

        const data = {
            date: document.getElementById('f_date').value,
            tour: document.getElementById('f_tour').value,
            name: document.getElementById('f_name').value,
            phone: document.getElementById('f_phone').value,
            pax: document.getElementById('f_pax').value,
            estRev: document.getElementById('f_estRev').value,
            actRev: document.getElementById('f_actRev').value,
            bookingId: document.getElementById('f_bookingId').value,
            contract: document.getElementById('f_contract').value,
            contractUploaded: document.getElementById('f_contractUploaded').value,
            paperSent: document.getElementById('f_paperSent').value,
            preTripNotify: document.getElementById('f_preTripNotify').value,
            deposit: document.getElementById('f_deposit').value,
            balance: document.getElementById('f_balance').value,
            billSent: document.getElementById('f_billSent').value,
            list: document.getElementById('f_list').value,
            room: document.getElementById('f_room').value,
            note: document.getElementById('f_note').value
        };

        const editIndex = document.getElementById('editIndex').value;

        if (editIndex === "-1") {
            salesData.push(data);
            if(data.date) currentTab = data.date.substring(0, 7);
        } else {
            salesData[editIndex] = data;
            document.getElementById('editIndex').value = "-1";
            document.querySelector('#recordForm button[type="submit"]').textContent = "儲存紀錄";
            document.querySelector('#recordForm button[type="submit"]').classList.remove('btn-warning');
            document.querySelector('#recordForm button[type="submit"]').classList.add('btn-primary');
            if(data.date) currentTab = data.date.substring(0, 7);
        }

        renderTabs(); 
        renderTable();
        resetForm();
        
        // ★★★ 觸發雲端儲存 ★★★
        saveToCloud();
    }

    function editData(index) {
        const row = salesData[index];
        const safe = (val) => val || '';
        document.getElementById('f_date').value = safe(row.date);
        document.getElementById('f_tour').value = safe(row.tour);
        document.getElementById('f_name').value = safe(row.name);
        document.getElementById('f_phone').value = safe(row.phone);
        document.getElementById('f_pax').value = safe(row.pax);
        document.getElementById('f_bookingId').value = safe(row.bookingId);
        document.getElementById('f_estRev').value = safe(row.estRev);
        document.getElementById('f_actRev').value = safe(row.actRev);
        document.getElementById('f_contract').value = safe(row.contract);
        document.getElementById('f_contractUploaded').value = safe(row.contractUploaded);
        document.getElementById('f_paperSent').value = safe(row.paperSent);
        document.getElementById('f_preTripNotify').value = safe(row.preTripNotify);
        document.getElementById('f_deposit').value = safe(row.deposit);
        document.getElementById('f_balance').value = safe(row.balance);
        document.getElementById('f_billSent').value = safe(row.billSent);
        document.getElementById('f_list').value = safe(row.list);
        document.getElementById('f_room').value = safe(row.room);
        document.getElementById('f_note').value = safe(row.note);

        document.getElementById('editIndex').value = index;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        const submitBtn = document.querySelector('#recordForm button[type="submit"]');
        submitBtn.textContent = "更新資料";
        submitBtn.classList.remove('btn-primary');
        submitBtn.classList.add('btn-warning');
    }

    function deleteData(index) {
        if(confirm('確定要刪除這筆資料嗎？刪除後會同步更新至雲端。')) {
            salesData.splice(index, 1);
            renderTabs(); 
            renderTable();
            // ★★★ 觸發雲端儲存 ★★★
            saveToCloud();
        }
    }

    function resetForm() {
        document.getElementById('recordForm').reset();
        document.getElementById('editIndex').value = "-1";
        const submitBtn = document.querySelector('#recordForm button[type="submit"]');
        submitBtn.textContent = "儲存紀錄";
        submitBtn.classList.remove('btn-warning');
        submitBtn.classList.add('btn-primary');
    }

    function clearAllData() {
        if(confirm('警告：這將會刪除所有 Google Sheet 上的資料且無法復原！')) {
            salesData = [];
            currentTab = 'ALL';
            renderTabs();
            renderTable();
            // ★★★ 觸發雲端儲存 (會把空陣列傳上去，等於清空) ★★★
            saveToCloud();
        }
    }
    
    // 匯出功能保留，當作手動備份用
    function exportToCSV() {
        let csvContent = "\uFEFF"; 
        csvContent += headers.join(",") + "\n";
        salesData.forEach(row => {
            const safe = (val) => val || '';
            let rowArray = [
                safe(row.date), `"${safe(row.tour)}"`, safe(row.name), `'${safe(row.phone)}`, safe(row.pax),
                safe(row.estRev), safe(row.actRev), safe(row.bookingId), safe(row.contract), 
                safe(row.contractUploaded), safe(row.paperSent), safe(row.preTripNotify),
                safe(row.deposit), safe(row.balance), safe(row.billSent), safe(row.list), safe(row.room), `"${safe(row.note)}"`
            ];
            csvContent += rowArray.join(",") + "\n";
        });
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        const now = new Date();
        link.download = `業務出團表_${now.getMonth()+1}_${now.getDate()}.csv`;
        link.click();
    }

    // 匯入功能 (會把資料跟雲端合併)
    function importFromCSV(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const rows = text.split("\n");
            let newData = [];
            for (let i = 1; i < rows.length; i++) {
                let cols = rows[i].split(",");
                if (cols.length < 5) continue; 
                const clean = (str) => str ? str.replace(/^"|"$/g, '').replace(/^'/, '').trim() : '';
                let obj = {
                    date: clean(cols[0]), tour: clean(cols[1]), name: clean(cols[2]), phone: clean(cols[3]),
                    pax: clean(cols[4]), estRev: clean(cols[5]), actRev: clean(cols[6]), bookingId: clean(cols[7]),
                    contract: clean(cols[8]), contractUploaded: clean(cols[9]), paperSent: clean(cols[10]), 
                    preTripNotify: clean(cols[11]),
                    deposit: clean(cols[12]), balance: clean(cols[13]), billSent: clean(cols[14]), 
                    list: clean(cols[15]), room: clean(cols[16]), note: clean(cols[17])
                };
                newData.push(obj);
            }
            if(confirm(`解析到 ${newData.length} 筆資料，確定要覆蓋現有資料嗎？(取消則附加)`)) {
                salesData = newData;
            } else {
                salesData = salesData.concat(newData);
            }
            renderTabs(); 
            renderTable();
            input.value = ''; 
            // 匯入後同步到雲端
            saveToCloud();
        };
        reader.readAsText(file);
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>