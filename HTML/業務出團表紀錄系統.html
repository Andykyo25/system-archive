<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>業務出團表紀錄系統 v3.5 (Fast Load)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        
        .table-container { 
            overflow-x: auto; 
            background: white; 
            border-radius: 0 0 8px 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            padding: 15px; 
            border-top: none;
        }

        .table thead th { 
            background-color: #e9ecef !important; 
            color: #495057; 
            font-weight: bold;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap; 
            vertical-align: middle; 
            text-align: center;
        }

        .th-highlight { background-color: #f3e5f5 !important; color: #6a1b9a; }
        .th-alert { background-color: #fff3e0 !important; color: #e65100; } 

        td { white-space: nowrap; vertical-align: middle; text-align: center; font-size: 0.95rem; }
        .text-left { text-align: left !important; }
        
        .status-v { color: #198754; font-weight: bold; background-color: #e8f5e9; padding: 2px 8px; border-radius: 4px; }
        
        .summary-panel {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-left: 5px solid #0d6efd;
        }
        .summary-item h5 { margin: 0; font-size: 0.9rem; color: #6c757d; }
        .summary-item .value { font-size: 1.5rem; font-weight: bold; color: #212529; }
        .text-success-dark { color: #198754 !important; }

        .badge-date { font-size: 0.75rem; margin-left: 5px; }
        
        .nav-tabs .nav-link { color: #495057; background-color: #e9ecef; margin-right: 2px; border-radius: 8px 8px 0 0; }
        .nav-tabs .nav-link.active { color: #0d6efd; background-color: white; border-top: 3px solid #0d6efd; font-weight: bold; }
        .nav-tabs { border-bottom: 1px solid #dee2e6; }

        .form-card { border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-card .card-header { background-color: white; border-bottom: 1px solid #eee; color: #0d6efd; font-size: 1.1rem; }
        .form-card .card-body { background-color: #ffffff; }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        /* 同步狀態指示器 */
        #syncStatus {
            font-size: 0.85rem;
            margin-right: 15px;
            font-weight: bold;
            color: #6c757d;
        }
        .fa-spin-fast { animation: fa-spin 1s infinite linear; }
    </style>
</head>
<body>

<div class="container-fluid">
    <h2 class="mb-3 text-center text-secondary"><i class="fas fa-plane-departure"></i> 業務出團管理系統</h2>

    <!-- 操作區塊 -->
    <div class="row mb-3">
        <div class="col-md-12 text-end d-flex align-items-center justify-content-end">
            <!-- 同步狀態顯示區 -->
            <span id="syncStatus"></span>

            <button class="btn btn-outline-success btn-sm me-1" onclick="exportToCSV()"><i class="fas fa-file-excel"></i> 匯出 Excel</button>
            <label class="btn btn-outline-warning btn-sm btn-file me-1">
                <i class="fas fa-file-upload"></i> 匯入 CSV <input type="file" id="csvFileInput" style="display: none;" onchange="importFromCSV(this)">
            </label>
            <button class="btn btn-outline-danger btn-sm" onclick="clearAllData()"><i class="fas fa-trash"></i> 清空</button>
        </div>
    </div>

    <!-- 輸入表單 -->
    <div class="card form-card">
        <div class="card-header">
            <strong><i class="fas fa-edit"></i> 資料輸入 / 編輯區</strong>
        </div>
        <div class="card-body">
            <form id="recordForm" onsubmit="event.preventDefault(); saveRecord();">
                <input type="hidden" id="editIndex" value="-1">
                <div class="row g-2">
                    <div class="col-md-2"><label class="form-label">出發日期</label><input type="date" class="form-control" id="f_date" required></div>
                    <div class="col-md-3"><label class="form-label">行程</label><input type="text" class="form-control" id="f_tour" placeholder="例如: 芬蘭破冰船15日" required></div>
                    <div class="col-md-2"><label class="form-label">客人代表</label><input type="text" class="form-control" id="f_name" required></div>
                    <div class="col-md-2"><label class="form-label">電話號碼</label><input type="text" class="form-control" id="f_phone"></div>
                    <div class="col-md-1"><label class="form-label">人數</label><input type="number" class="form-control" id="f_pax" min="1"></div>
                    <div class="col-md-2"><label class="form-label">訂編</label><input type="text" class="form-control" id="f_bookingId"></div>
                    
                    <div class="col-md-2"><label class="form-label">預估業績</label><input type="number" class="form-control" id="f_estRev"></div>
                    <div class="col-md-2"><label class="form-label">實際業績</label><input type="number" class="form-control" id="f_actRev"></div>
                    
                    <div class="col-md-2"><label class="form-label">合約狀態</label>
                        <select class="form-select" id="f_contract">
                            <option value="">未簽約</option>
                            <option value="線上">線上</option>
                            <option value="紙本">紙本</option>
                            <option value="PDF">PDF</option>
                        </select>
                    </div>
                    <div class="col-md-2"><label class="form-label text-primary">合約上傳</label>
                        <select class="form-select" id="f_contractUploaded"><option value="">否</option><option value="V">是 (V)</option></select>
                    </div>
                    <div class="col-md-2"><label class="form-label text-primary">寄出紙本</label>
                        <select class="form-select" id="f_paperSent"><option value="">否</option><option value="V">是 (V)</option></select>
                    </div>
                    <div class="col-md-2"><label class="form-label text-danger">行前通知</label>
                        <select class="form-select" id="f_preTripNotify"><option value="">否</option><option value="V">是 (V)</option></select>
                    </div>
                    
                    <div class="col-md-2"><label class="form-label">訂金</label><input type="number" class="form-control" id="f_deposit"></div>
                    <div class="col-md-2"><label class="form-label">尾款</label><input type="number" class="form-control" id="f_balance"></div>
                    <div class="col-md-2"><label class="form-label text-primary">繳帳單</label>
                        <select class="form-select" id="f_billSent"><option value="">否</option><option value="V">是 (V)</option></select>
                    </div>

                    <div class="col-md-1"><label class="form-label">名單</label><select class="form-select" id="f_list"><option value="">-</option><option value="V">V</option></select></div>
                    <div class="col-md-1"><label class="form-label">分房</label><select class="form-select" id="f_room"><option value="">-</option><option value="V">V</option></select></div>
                    
                    <div class="col-md-4"><label class="form-label">備註</label><input type="text" class="form-control" id="f_note" placeholder="備註事項..."></div>
                </div>
                <div class="mt-3 text-center">
                    <button type="submit" class="btn btn-primary w-25">儲存紀錄</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">重置</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 月份分頁 Tabs -->
    <ul class="nav nav-tabs" id="monthTabs">
        <li class="nav-item"><a class="nav-link active" href="#">全部顯示</a></li>
    </ul>

    <!-- 統計儀表板 -->
    <div class="summary-panel" id="summaryPanel">
        <div class="summary-item text-center">
            <h5><i class="fas fa-users"></i> 總人數</h5>
            <div class="value" id="sumPax">0</div>
        </div>
        <div class="summary-item text-center">
            <h5><i class="fas fa-sack-dollar"></i> 預估業績總額</h5>
            <div class="value text-primary" id="sumEst">0</div>
        </div>
        <div class="summary-item text-center">
            <h5><i class="fas fa-coins"></i> 實際業績總額</h5>
            <div class="value text-success-dark" id="sumAct">0</div>
        </div>
    </div>

    <!-- 表格與分頁 -->
    <div class="table-container">
        <!-- 分頁控制區 -->
        <div class="pagination-controls">
            <div class="d-flex align-items-center">
                <span class="me-2">每頁顯示:</span>
                <select class="form-select form-select-sm" id="rowsPerPage" style="width: 80px;" onchange="changeRowsPerPage()">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="9999">全部</option>
                </select>
                <span class="ms-3 text-muted" id="pageInfo">第 1 頁 / 共 1 頁</span>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-secondary" onclick="changePage(-1)" id="btnPrev"><i class="fas fa-chevron-left"></i> 上一頁</button>
                <button class="btn btn-sm btn-outline-secondary ms-1" onclick="changePage(1)" id="btnNext">下一頁 <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <table class="table table-hover table-striped" id="dataTable">
            <thead>
                <tr>
                    <th style="width: 80px;">操作</th>
                    <th>出發日期</th>
                    <th>行程</th>
                    <th>客人代表</th>
                    <th>電話</th>
                    <th>人數</th>
                    <th>預估業績</th>
                    <th>實際業績</th>
                    <th>訂編</th>
                    <th>合約</th>
                    <th class="th-highlight">合約上傳</th>
                    <th class="th-highlight">寄出紙本</th>
                    <th class="th-alert">行前通知</th>
                    <th>訂金</th>
                    <th>尾款</th>
                    <th class="th-highlight">繳帳單</th>
                    <th>名單</th>
                    <th>分房</th>
                    <th>備註</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- JS 插入資料 -->
            </tbody>
        </table>
    </div>
</div>

<script>
    // ★★★ API URL ★★★
    const API_URL = "https://script.google.com/macros/s/AKfycbw4H6vytYgQN_9i-WD6vxqm9t5D9ofQ0PLcbEXRACPIvlggeTw-Y0YEfHz1uMlbfwrM3w/exec";
    
    // 定義欄位名稱
    const headers = [
        "出發日期", "行程", "客人代表", "電話號碼", "人數", 
        "預估業績", "實際業績", "訂編", "合約", "合約上傳", "寄出紙本", "行前通知",
        "訂金", "尾款", "繳帳單", "名單", "分房", "備註"
    ];

    let salesData = []; 
    let currentTab = 'ALL'; 
    let isLoading = false; 

    // 分頁變數
    let currentPage = 1;
    let rowsPerPage = 10;
    let currentFilteredData = []; 

    // ★★★ 優化：載入時先讀取 LocalStorage ★★★
    window.onload = function() {
        // 1. 嘗試從 LocalStorage 讀取資料
        const cachedData = localStorage.getItem('salesGroupData_Cache');
        if (cachedData) {
            console.log("Found local cache, rendering immediately...");
            salesData = JSON.parse(cachedData);
            sortData();
            renderTabs();
            renderTable();
            // 如果有快取，背景靜默更新 (不擋畫面)
            loadFromCloud(false); 
        } else {
            console.log("No cache found, full loading...");
            // 如果沒快取，顯示遮罩並載入
            renderTable(); // 初始空表
            loadFromCloud(true); 
        }
    };

    // --- 雲端功能區 ---
    // isBlocking: true = 顯示全螢幕遮罩, false = 顯示右上角小提示
    function loadFromCloud(isBlocking = true) {
        if (isBlocking) {
            toggleLoading(true, "資料讀取中...");
        } else {
            updateSyncStatus(true, "雲端同步中...");
        }

        fetch(API_URL)
            .then(response => response.json())
            .then(data => {
                salesData = data;
                // 更新後存入快取
                saveToLocalCache();
                
                sortData();
                renderTabs();
                renderTable();

                if (isBlocking) {
                    toggleLoading(false);
                } else {
                    updateSyncStatus(false);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (isBlocking) {
                    alert("讀取失敗，請檢查網路。");
                    toggleLoading(false);
                } else {
                    updateSyncStatus(false); // 失敗也移除提示
                }
            });
    }

    function saveToCloud() {
        // 儲存時，我們希望使用者知道正在存，所以使用右上的狀態提示，或者遮罩皆可
        // 為了確保資料一致性，這裡使用遮罩比較安全，避免使用者連續按
        toggleLoading(true, "資料儲存中...");
        
        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify(salesData) 
        })
        .then(response => response.json())
        .then(result => {
            if(result.result === "success") {
                toggleLoading(false);
            } else {
                alert("儲存失敗：" + result.error);
                toggleLoading(false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("連線失敗，請檢查網路。");
            toggleLoading(false);
        });
    }

    // 將資料存入 LocalStorage 當作快取
    function saveToLocalCache() {
        localStorage.setItem('salesGroupData_Cache', JSON.stringify(salesData));
    }

    // 全螢幕遮罩
    function toggleLoading(show, msg) {
        isLoading = show;
        let loader = document.getElementById('loadingOverlay');
        if (!loader) {
            loader = document.createElement('div');
            loader.id = 'loadingOverlay';
            loader.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);z-index:9999;display:flex;justify-content:center;align-items:center;font-size:1.5rem;font-weight:bold;color:#0d6efd;";
            document.body.appendChild(loader);
        }
        loader.innerHTML = `<i class="fas fa-spinner fa-spin"></i> &nbsp; ${msg || '處理中...'}`;
        loader.style.display = show ? 'flex' : 'none';
    }

    // 右上角同步狀態提示
    function updateSyncStatus(show, msg) {
        const statusEl = document.getElementById('syncStatus');
        if (show) {
            statusEl.innerHTML = `<i class="fas fa-sync fa-spin-fast text-primary"></i> ${msg}`;
        } else {
            statusEl.innerHTML = `<i class="fas fa-check-circle text-success"></i> 已同步`;
            // 2秒後消失
            setTimeout(() => { statusEl.innerHTML = ''; }, 2000);
        }
    }

    // --- 核心邏輯 ---

    function sortData() {
        salesData.sort((a, b) => {
            const dateA = a.date ? new Date(a.date) : new Date('9999-12-31');
            const dateB = b.date ? new Date(b.date) : new Date('9999-12-31');
            return dateA - dateB;
        });
    }

    function safeNumber(val) {
        if (!val) return 0; 
        const num = parseInt(String(val).replace(/,/g, ''), 10);
        return isNaN(num) ? 0 : num;
    }

    function renderTabs() {
        const tabsContainer = document.getElementById('monthTabs');
        let months = new Set();
        salesData.forEach(row => {
            if(row.date) months.add(row.date.substring(0, 7));
        });
        let sortedMonths = Array.from(months).sort();

        let html = `<li class="nav-item"><button class="nav-link ${currentTab === 'ALL' ? 'active' : ''}" onclick="switchTab('ALL')">全部顯示</button></li>`;
        sortedMonths.forEach(m => {
            html += `<li class="nav-item"><button class="nav-link ${currentTab === m ? 'active' : ''}" onclick="switchTab('${m}')">${m}</button></li>`;
        });
        tabsContainer.innerHTML = html;
    }

    function switchTab(tab) {
        currentTab = tab;
        currentPage = 1; 
        renderTabs(); 
        renderTable(); 
    }

    function changeRowsPerPage() {
        rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
        currentPage = 1;
        renderTable();
    }

    function changePage(delta) {
        const totalPages = Math.ceil(currentFilteredData.length / rowsPerPage);
        let newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderTable();
        }
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        let totalPax = 0;
        let totalEst = 0;
        let totalAct = 0;
        
        let indexedData = salesData.map((item, index) => ({ ...item, originalIndex: index }));

        if (currentTab === 'ALL') {
            currentFilteredData = indexedData;
        } else {
            currentFilteredData = indexedData.filter(row => row.date && row.date.substring(0, 7) === currentTab);
        }

        currentFilteredData.forEach(row => {
            totalPax += safeNumber(row.pax);
            totalEst += safeNumber(row.estRev);
            totalAct += safeNumber(row.actRev);
        });

        document.getElementById('sumPax').textContent = totalPax;
        document.getElementById('sumEst').textContent = formatMoney(totalEst);
        document.getElementById('sumAct').textContent = formatMoney(totalAct);

        const totalRows = currentFilteredData.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;
        
        if (currentPage > totalPages) currentPage = totalPages;

        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const pageData = currentFilteredData.slice(startIndex, endIndex);

        document.getElementById('pageInfo').innerText = `第 ${currentPage} 頁 / 共 ${totalPages} 頁 (共 ${totalRows} 筆)`;
        document.getElementById('btnPrev').disabled = (currentPage === 1);
        document.getElementById('btnNext').disabled = (currentPage === totalPages);

        const today = new Date();
        today.setHours(0,0,0,0);

        pageData.forEach((row) => {
            const index = row.originalIndex; 
            const safe = (val) => val || '';

            let dateBadge = '';
            if (row.date) {
                const tripDate = new Date(row.date);
                const diffTime = tripDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                if (diffDays < 0) dateBadge = `<span class="badge bg-secondary badge-date">已出團</span>`;
                else if (diffDays <= 7) dateBadge = `<span class="badge bg-danger badge-date">剩${diffDays}天</span>`;
                else if (diffDays <= 30) dateBadge = `<span class="badge bg-warning text-dark badge-date">剩${diffDays}天</span>`;
            }

            let contractDisplay = safe(row.contract);
            if (contractDisplay === '未簽約') {
                contractDisplay = `<span class="text-danger fw-bold">${contractDisplay}</span>`;
            }

            let tr = document.createElement('tr');
            let btnTd = `
                <td>
                    <div class="btn-group-action">
                        <button class="btn btn-sm btn-outline-primary" onclick="editData(${index})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteData(${index})"><i class="fas fa-trash"></i></button>
                    </div>
                </td>`;
            
            let dataTd = `
                <td>${safe(row.date)} ${dateBadge}</td>
                <td class="text-left fw-bold">${safe(row.tour)}</td>
                <td>${safe(row.name)}</td>
                <td>${safe(row.phone)}</td>
                <td>${safe(row.pax)}</td>
                <td>${formatMoney(row.estRev)}</td>
                <td>${formatMoney(row.actRev)}</td>
                <td>${safe(row.bookingId)}</td>
                <td>${contractDisplay}</td>
                <td><span class="${row.contractUploaded === 'V' ? 'status-v' : ''}">${safe(row.contractUploaded)}</span></td>
                <td><span class="${row.paperSent === 'V' ? 'status-v' : ''}">${safe(row.paperSent)}</span></td>
                <td><span class="${row.preTripNotify === 'V' ? 'status-v' : ''}">${safe(row.preTripNotify)}</span></td>
                <td>${formatMoney(row.deposit)}</td>
                <td>${formatMoney(row.balance)}</td>
                <td><span class="${row.billSent === 'V' ? 'status-v' : ''}">${safe(row.billSent)}</span></td>
                <td><span class="${row.list === 'V' ? 'status-v' : ''}">${safe(row.list)}</span></td>
                <td><span class="${row.room === 'V' ? 'status-v' : ''}">${safe(row.room)}</span></td>
                <td class="text-left text-muted" style="font-size:0.85rem;">${safe(row.note)}</td>
            `;

            tr.innerHTML = btnTd + dataTd;
            tbody.appendChild(tr);
        });
    }

    function formatMoney(num) {
        if (!num) return '0';
        const n = parseInt(String(num).replace(/,/g, ''), 10);
        if (isNaN(n)) return '0';
        return n.toLocaleString();
    }

    function saveRecord() {
        if (isLoading) return;

        const data = {
            date: document.getElementById('f_date').value,
            tour: document.getElementById('f_tour').value,
            name: document.getElementById('f_name').value,
            phone: document.getElementById('f_phone').value,
            pax: document.getElementById('f_pax').value,
            estRev: document.getElementById('f_estRev').value,
            actRev: document.getElementById('f_actRev').value,
            bookingId: document.getElementById('f_bookingId').value,
            contract: document.getElementById('f_contract').value,
            contractUploaded: document.getElementById('f_contractUploaded').value,
            paperSent: document.getElementById('f_paperSent').value,
            preTripNotify: document.getElementById('f_preTripNotify').value,
            deposit: document.getElementById('f_deposit').value,
            balance: document.getElementById('f_balance').value,
            billSent: document.getElementById('f_billSent').value,
            list: document.getElementById('f_list').value,
            room: document.getElementById('f_room').value,
            note: document.getElementById('f_note').value
        };

        const editIndex = document.getElementById('editIndex').value;

        if (editIndex === "-1") {
            salesData.push(data);
            if(data.date) currentTab = data.date.substring(0, 7);
        } else {
            salesData[editIndex] = data;
            document.getElementById('editIndex').value = "-1";
            document.querySelector('#recordForm button[type="submit"]').textContent = "儲存紀錄";
            document.querySelector('#recordForm button[type="submit"]').classList.remove('btn-warning');
            document.querySelector('#recordForm button[type="submit"]').classList.add('btn-primary');
            if(data.date) currentTab = data.date.substring(0, 7);
        }

        // 儲存後立刻更新快取
        saveToLocalCache();

        sortData(); 
        renderTabs(); 
        renderTable();
        resetForm();
        saveToCloud();
    }

    function editData(index) {
        const row = salesData[index];
        const safe = (val) => val || '';
        document.getElementById('f_date').value = safe(row.date);
        document.getElementById('f_tour').value = safe(row.tour);
        document.getElementById('f_name').value = safe(row.name);
        document.getElementById('f_phone').value = safe(row.phone);
        document.getElementById('f_pax').value = safe(row.pax);
        document.getElementById('f_bookingId').value = safe(row.bookingId);
        document.getElementById('f_estRev').value = safe(row.estRev);
        document.getElementById('f_actRev').value = safe(row.actRev);
        document.getElementById('f_contract').value = safe(row.contract);
        document.getElementById('f_contractUploaded').value = safe(row.contractUploaded);
        document.getElementById('f_paperSent').value = safe(row.paperSent);
        document.getElementById('f_preTripNotify').value = safe(row.preTripNotify);
        document.getElementById('f_deposit').value = safe(row.deposit);
        document.getElementById('f_balance').value = safe(row.balance);
        document.getElementById('f_billSent').value = safe(row.billSent);
        document.getElementById('f_list').value = safe(row.list);
        document.getElementById('f_room').value = safe(row.room);
        document.getElementById('f_note').value = safe(row.note);

        document.getElementById('editIndex').value = index;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        const submitBtn = document.querySelector('#recordForm button[type="submit"]');
        submitBtn.textContent = "更新資料";
        submitBtn.classList.remove('btn-primary');
        submitBtn.classList.add('btn-warning');
    }

    function deleteData(index) {
        if(confirm('確定要刪除這筆資料嗎？刪除後會同步更新至雲端。')) {
            salesData.splice(index, 1);
            saveToLocalCache(); // 更新快取
            renderTabs(); 
            renderTable();
            saveToCloud();
        }
    }

    function resetForm() {
        document.getElementById('recordForm').reset();
        document.getElementById('editIndex').value = "-1";
        const submitBtn = document.querySelector('#recordForm button[type="submit"]');
        submitBtn.textContent = "儲存紀錄";
        submitBtn.classList.remove('btn-warning');
        submitBtn.classList.add('btn-primary');
    }

    function clearAllData() {
        if(confirm('警告：這將會刪除所有 Google Sheet 上的資料且無法復原！')) {
            salesData = [];
            currentTab = 'ALL';
            saveToLocalCache();
            renderTabs();
            renderTable();
            saveToCloud();
        }
    }
    
    function exportToCSV() {
        let csvContent = "\uFEFF"; 
        csvContent += headers.join(",") + "\n";
        salesData.forEach(row => {
            const safe = (val) => val || '';
            let rowArray = [
                safe(row.date), `"${safe(row.tour)}"`, safe(row.name), `'${safe(row.phone)}`, safe(row.pax),
                safe(row.estRev), safe(row.actRev), safe(row.bookingId), safe(row.contract), 
                safe(row.contractUploaded), safe(row.paperSent), safe(row.preTripNotify),
                safe(row.deposit), safe(row.balance), safe(row.billSent), safe(row.list), safe(row.room), `"${safe(row.note)}"`
            ];
            csvContent += rowArray.join(",") + "\n";
        });
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        const now = new Date();
        link.download = `業務出團表_${now.getMonth()+1}_${now.getDate()}.csv`;
        link.click();
    }

    function importFromCSV(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const rows = text.split("\n");
            let newData = [];
            for (let i = 1; i < rows.length; i++) {
                let cols = rows[i].split(",");
                if (cols.length < 5) continue; 
                const clean = (str) => str ? str.replace(/^"|"$/g, '').replace(/^'/, '').trim() : '';
                let obj = {
                    date: clean(cols[0]), tour: clean(cols[1]), name: clean(cols[2]), phone: clean(cols[3]),
                    pax: clean(cols[4]), estRev: clean(cols[5]), actRev: clean(cols[6]), bookingId: clean(cols[7]),
                    contract: clean(cols[8]), contractUploaded: clean(cols[9]), paperSent: clean(cols[10]), 
                    preTripNotify: clean(cols[11]),
                    deposit: clean(cols[12]), balance: clean(cols[13]), billSent: clean(cols[14]), 
                    list: clean(cols[15]), room: clean(cols[16]), note: clean(cols[17])
                };
                newData.push(obj);
            }
            if(confirm(`解析到 ${newData.length} 筆資料，確定要覆蓋現有資料嗎？(取消則附加)`)) {
                salesData = newData;
            } else {
                salesData = salesData.concat(newData);
            }
            saveToLocalCache();
            sortData(); 
            renderTabs(); 
            renderTable();
            input.value = ''; 
            saveToCloud();
        };
        reader.readAsText(file);
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>