<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£è³¼æ˜ç´°çµ±è¨ˆç³»çµ±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .glass-panel {
            background: rgba(255, 255, 255, 1);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        .form-input { transition: all 0.3s ease; }
        .form-input:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.1);
        }
        .sortable-header { cursor: pointer; user-select: none; transition: color 0.2s; }
        .sortable-header:hover { color: #4f46e5; }
        
        .rank-1 { background-color: #fbbf24; color: #fff; }
        .rank-2 { background-color: #94a3b8; color: #fff; }
        .rank-3 { background-color: #b45309; color: #fff; }
        .rank-other { background-color: #f1f5f9; color: #64748b; }

        /* Tab Transition */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-600">

<div id="app" class="min-h-screen p-4 md:p-8 max-w-7xl mx-auto flex flex-col">

    <!-- Header & Controls -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div>
            <h1 class="text-3xl font-bold text-slate-800 tracking-tight">ä»£è³¼æ˜ç´°çµ±è¨ˆç³»çµ±</h1>
            <p class="text-slate-400 text-sm mt-1">æ™ºæ…§åˆ†æèˆ‡åº«å­˜ç®¡ç†</p>
        </div>
        
        <!-- View Switcher Tabs -->
        <div class="bg-slate-100 p-1 rounded-lg flex shadow-inner">
            <button @click="currentView = 'dashboard'" :class="currentView === 'dashboard' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'" class="px-6 py-2 rounded-md text-sm font-bold transition duration-200 flex items-center gap-2">
                ğŸ“Š å„€è¡¨æ¿
            </button>
            <button @click="currentView = 'customers'" :class="currentView === 'customers' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'" class="px-6 py-2 rounded-md text-sm font-bold transition duration-200 flex items-center gap-2">
                ğŸ‘¥ é¡§å®¢åˆ†æ
            </button>
        </div>

        <div class="flex gap-2 text-sm">
            <button @click="triggerFileInput" class="bg-white hover:bg-slate-50 text-slate-600 px-4 py-2 rounded-lg border border-slate-200 shadow-sm transition flex items-center gap-2">
                ğŸ“‚ åŒ¯å…¥
            </button>
            <input type="file" ref="fileInput" class="hidden" @change="importData" accept=".json">
            
            <button @click="exportData" class="bg-white hover:bg-slate-50 text-slate-600 px-4 py-2 rounded-lg border border-slate-200 shadow-sm transition flex items-center gap-2">
                ğŸ’¾ å‚™ä»½
            </button>
            <button @click="clearAll" class="bg-white hover:bg-red-50 text-slate-600 hover:text-red-500 px-4 py-2 rounded-lg border border-slate-200 shadow-sm transition">
                ğŸ—‘ï¸ æ¸…é™¤
            </button>
        </div>
    </header>

    <!-- VIEW 1: DASHBOARD -->
    <div v-if="currentView === 'dashboard'" class="animate-fade">
        <!-- Dashboard Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-2xl p-6 text-white shadow-lg shadow-indigo-200 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="text-indigo-100 text-sm font-medium mb-1">ç¸½ç‡Ÿæ¥­é¡ (å ±åƒ¹ç¸½è¨ˆ)</div>
                    <div class="text-3xl font-bold tracking-tight">{{ formatCurrency(totalRevenue) }}</div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-6 text-white shadow-lg shadow-emerald-200 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="text-emerald-100 text-sm font-medium mb-1">æ·¨åˆ©æ½¤ (å·²æ‰£é‹è²»)</div>
                    <div class="text-3xl font-bold tracking-tight">{{ formatCurrency(totalProfit) }}</div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-orange-400 to-orange-500 rounded-2xl p-6 text-white shadow-lg shadow-orange-200 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="text-orange-100 text-sm font-medium mb-1">ç¸½è¨‚å–®æ•¸</div>
                    <div class="text-3xl font-bold tracking-tight">{{ items.length }} <span class="text-lg font-normal opacity-80">ç­†</span></div>
                </div>
            </div>
            <div class="bg-gradient-to-br from-rose-500 to-rose-600 rounded-2xl p-6 text-white shadow-lg shadow-rose-200 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="text-rose-100 text-sm font-medium mb-1">æœªç¹³æ¸…æ¬¾é …</div>
                    <div class="text-3xl font-bold tracking-tight">{{ unpaidCount }} <span class="text-lg font-normal opacity-80">ç­†</span></div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="glass-panel p-6 bg-white">
                <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <span class="w-1 h-6 bg-indigo-500 rounded-full"></span> å“ç‰ŒéŠ·å”®ä½”æ¯”
                </h3>
                <div class="relative h-64">
                    <canvas id="brandChart"></canvas>
                </div>
            </div>
            <div class="glass-panel p-6 bg-white">
                <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <span class="w-1 h-6 bg-indigo-500 rounded-full"></span> æœˆåº¦éŠ·å”®åˆ©æ½¤è¶¨å‹¢
                </h3>
                <div class="relative h-64">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Rankings Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="glass-panel p-6 bg-white">
                <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <span class="w-1 h-6 bg-orange-400 rounded-full"></span> ç†±éŠ·å“ç‰Œ (Top 5)
                </h3>
                <div class="overflow-y-auto max-h-60">
                    <table class="w-full text-sm">
                        <thead class="text-xs text-slate-400 bg-slate-50 uppercase sticky top-0">
                            <tr><th class="px-3 py-2 text-left">æ’å</th><th class="px-3 py-2 text-left">å“ç‰Œ</th><th class="px-3 py-2 text-right">éŠ·é‡</th></tr>
                        </thead>
                        <tbody>
                            <tr v-for="(brand, idx) in topSellingBrands" :key="idx" class="border-b border-slate-50 hover:bg-slate-50">
                                <td class="px-3 py-3 w-12"><span :class="getRankClass(idx)" class="flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold">{{ idx + 1 }}</span></td>
                                <td class="px-3 py-3 font-bold text-slate-700">{{ brand.name }}</td>
                                <td class="px-3 py-3 text-right font-bold text-slate-600">{{ brand.count }} ä»¶</td>
                            </tr>
                            <tr v-if="topSellingBrands.length === 0"><td colspan="3" class="text-center py-4 text-gray-400">ç„¡è³‡æ–™</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="glass-panel p-6 bg-white">
                <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <span class="w-1 h-6 bg-emerald-500 rounded-full"></span> åˆ©æ½¤ç‹ (å–®å“ Top 5)
                </h3>
                <div class="overflow-y-auto max-h-60">
                    <table class="w-full text-sm">
                        <thead class="text-xs text-slate-400 bg-slate-50 uppercase sticky top-0">
                            <tr><th class="px-3 py-2 text-left">æ’å</th><th class="px-3 py-2 text-left">å“å</th><th class="px-3 py-2 text-right">ç¸½åˆ©æ½¤</th></tr>
                        </thead>
                        <tbody>
                            <tr v-for="(prod, idx) in topProfitProducts" :key="idx" class="border-b border-slate-50 hover:bg-slate-50">
                                <td class="px-3 py-3 w-12"><span :class="getRankClass(idx)" class="flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold">{{ idx + 1 }}</span></td>
                                <td class="px-3 py-3"><div class="font-bold text-slate-700">{{ prod.name }}</div><div class="text-xs text-slate-400">{{ prod.brand }}</div></td>
                                <td class="px-3 py-3 text-right font-bold text-emerald-600 font-mono">{{ formatCurrency(prod.totalProfit) }}</td>
                            </tr>
                            <tr v-if="topProfitProducts.length === 0"><td colspan="3" class="text-center py-4 text-gray-400">ç„¡è³‡æ–™</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <div id="inputForm" class="glass-panel p-6 mb-8 bg-white transition-all duration-500" :class="{'ring-2 ring-indigo-400 shadow-xl': isEditing}">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-slate-100 pb-4 gap-4">
                <h2 class="text-xl font-bold text-indigo-700 flex items-center gap-2">
                    <span class="text-2xl">{{ isEditing ? 'âœï¸' : 'ğŸ“' }}</span> 
                    {{ isEditing ? 'ç·¨è¼¯è¨‚å–®' : 'æ–°å¢è¨‚å–®' }}
                </h2>
                
                <div class="flex items-center gap-2 bg-slate-50 p-1.5 rounded-lg border border-slate-200">
                    <label class="text-xs font-bold text-slate-500 ml-2">å¹£åˆ¥:</label>
                    <select v-model="newItem.currency" class="bg-white border border-slate-200 text-slate-700 text-sm rounded-md focus:ring-indigo-500 focus:border-indigo-500 block p-1.5 outline-none font-bold">
                        <option v-for="c in currencyList" :value="c">{{ c }}</option>
                    </select>
                    <div class="flex items-center border-l border-slate-200 pl-2 gap-1">
                        <input type="text" v-model="newCurrencyInput" placeholder="ä»£ç¢¼" class="w-16 text-sm p-1.5 rounded border border-slate-200 outline-none uppercase placeholder:normal-case">
                        <button @click="addCurrency" class="bg-indigo-100 text-indigo-600 hover:bg-indigo-200 p-1.5 rounded text-xs font-bold transition">ï¼‹</button>
                    </div>
                </div>

                <div class="flex gap-2 w-full md:w-auto">
                    <button v-if="isEditing" @click="cancelEdit" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-6 py-2.5 rounded-full shadow-sm transition font-bold text-sm flex-1 md:flex-none">å–æ¶ˆ</button>
                    <button @click="handleItemSubmit" :class="isEditing ? 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200' : 'bg-indigo-600 hover:bg-indigo-700 shadow-indigo-200'" class="text-white px-8 py-2.5 rounded-full shadow-lg transform active:scale-95 transition font-bold text-sm flex-1 md:flex-none">
                        {{ isEditing ? 'ğŸ’¾ å„²å­˜ä¿®æ”¹' : 'ï¼‹ æ–°å¢è³‡æ–™' }}
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-5">
                <div class="col-span-1"><label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">ä¸‹å–®æ—¥æœŸ</label><input type="date" v-model="newItem.date" class="form-input w-full p-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none text-sm"></div>
                <div class="col-span-1"><label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">é¡§å®¢å§“å</label><input type="text" v-model="newItem.customer" placeholder="è¼¸å…¥å§“å" class="form-input w-full p-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none text-sm"></div>
                <div class="col-span-1"><label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">å“ç‰Œ</label><input type="text" v-model="newItem.brand" list="brandList" placeholder="é¸æ“‡æˆ–è¼¸å…¥" class="form-input w-full p-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none text-sm"><datalist id="brandList"><option v-for="b in uniqueBrands" :value="b"></option></datalist></div>
                <div class="col-span-1"><label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">å“å</label><input type="text" v-model="newItem.productName" placeholder="ç”¢å“åç¨±" class="form-input w-full p-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none text-sm"></div>
                <div class="col-span-1"><label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">å‹è™Ÿ</label><input type="text" v-model="newItem.model" placeholder="ex: A-101" class="form-input w-full p-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none text-sm"></div>
                <div class="col-span-1 flex items-end"><label class="flex items-center space-x-2 cursor-pointer bg-slate-100 px-4 rounded-xl w-full h-[42px] border border-transparent hover:border-indigo-200 transition"><input type="checkbox" v-model="newItem.isPaid" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"><span class="text-sm font-medium text-slate-600">å·²ç¹³æ¸…æ¬¾é …</span></label></div>

                <div class="col-span-2 md:col-span-6 border-t border-slate-100 my-1"></div>

                <div class="col-span-1"><label class="text-xs font-bold text-slate-400 ml-1 mb-1 block">{{ newItem.currency }} åŸåƒ¹</label><input type="number" v-model.number="newItem.priceJPY" :placeholder="getCurrencySymbol(newItem.currency)" class="form-input w-full p-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-slate-400 focus:outline-none text-sm"></div>
                <div class="col-span-1"><label class="text-xs font-bold text-orange-400 ml-1 mb-1 block">{{ newItem.currency }} æŠ˜å¾Œ</label><input type="number" v-model.number="newItem.priceDiscountJPY" :placeholder="getCurrencySymbol(newItem.currency)" class="form-input w-full p-2.5 rounded-xl border border-orange-100 bg-orange-50 focus:bg-white focus:border-orange-500 focus:outline-none text-sm"></div>
                <div class="col-span-1"><label class="text-xs font-bold text-blue-400 ml-1 mb-1 block">{{ newItem.currency }} é€€ç¨…å¾Œ</label><input type="number" v-model.number="newItem.priceTaxFreeJPY" :placeholder="getCurrencySymbol(newItem.currency)" class="form-input w-full p-2.5 rounded-xl border border-blue-100 bg-blue-50 focus:bg-white focus:border-blue-500 focus:outline-none text-sm"></div>
                
                <div class="col-span-1"><label class="text-xs font-bold text-indigo-400 ml-1 mb-1 block">å°å¹£æˆæœ¬</label><input type="number" v-model.number="newItem.priceTWD" @input="calculateProfit" class="form-input w-full p-2.5 rounded-xl border border-indigo-100 bg-indigo-50 focus:bg-white focus:border-indigo-500 focus:outline-none font-medium text-sm"></div>
                <div class="col-span-1"><label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">é‹è²» (æˆæœ¬)</label><input type="number" v-model.number="newItem.shipping" @input="calculateProfit" placeholder="æœƒæ‰£é™¤åˆ©æ½¤" class="form-input w-full p-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none text-sm"></div>
                <div class="col-span-1"><label class="text-xs font-bold text-indigo-600 ml-1 mb-1 block">å ±åƒ¹ (ç¸½æ”¶å…¥)</label><input type="number" v-model.number="newItem.quotePrice" @input="calculateProfit" class="form-input w-full p-2.5 rounded-xl border-2 border-indigo-100 bg-white focus:border-indigo-500 focus:outline-none font-bold text-indigo-700 text-sm"></div>
                <div class="col-span-2 md:col-span-6 flex justify-end mt-2">
                     <div class="bg-emerald-50 px-5 py-2 rounded-xl border border-emerald-100 flex items-center gap-3"><span class="text-xs text-emerald-600 font-bold uppercase tracking-wider">é ä¼°åˆ©æ½¤</span><input type="number" v-model.number="newItem.profit" class="bg-transparent font-bold text-xl text-emerald-600 outline-none w-32 text-right" placeholder="0"></div>
                </div>
            </div>
        </div>

        <!-- Order Table -->
        <div class="glass-panel overflow-hidden bg-white mb-12">
            <div class="p-4 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4 bg-slate-50">
                <div class="flex items-center gap-2">
                    <span class="text-sm text-slate-500">é¡¯ç¤º</span>
                    <select v-model="itemsPerPage" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-1.5 outline-none font-medium">
                        <option :value="10">10</option><option :value="20">20</option><option :value="50">50</option>
                    </select>
                    <span class="text-sm text-slate-500">ç­† / é </span>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="currentPage--" :disabled="currentPage === 1" class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed text-sm">ä¸Šä¸€é </button>
                    <span class="text-sm font-medium text-slate-600 min-w-[60px] text-center">{{ currentPage }} / {{ totalPages || 1 }}</span>
                    <button @click="currentPage++" :disabled="currentPage >= totalPages" class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed text-sm">ä¸‹ä¸€é </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th @click="sortBy('date')" class="px-4 py-4 font-bold sortable-header">æ—¥æœŸ <span v-if="sortKey === 'date'">{{ sortOrder === 1 ? 'â–²' : 'â–¼' }}</span></th>
                            <th @click="sortBy('brand')" class="px-4 py-4 font-bold sortable-header">å“ç‰Œ / å“å <span v-if="sortKey === 'brand'">{{ sortOrder === 1 ? 'â–²' : 'â–¼' }}</span></th>
                            <th @click="sortBy('customer')" class="px-4 py-4 font-bold sortable-header">é¡§å®¢ <span v-if="sortKey === 'customer'">{{ sortOrder === 1 ? 'â–²' : 'â–¼' }}</span></th>
                            <th class="px-4 py-4 w-36 font-bold">å¤–å¹£æ˜ç´°</th>
                            <th @click="sortBy('priceTWD')" class="px-4 py-4 font-bold sortable-header">å°å¹£æˆæœ¬ <span v-if="sortKey === 'priceTWD'">{{ sortOrder === 1 ? 'â–²' : 'â–¼' }}</span></th>
                            <th class="px-4 py-4 font-bold">é‹è²»(æ‰£åˆ©æ½¤)</th>
                            <th @click="sortBy('quotePrice')" class="px-4 py-4 font-bold sortable-header">å ±åƒ¹ <span v-if="sortKey === 'quotePrice'">{{ sortOrder === 1 ? 'â–²' : 'â–¼' }}</span></th>
                            <th @click="sortBy('profit')" class="px-4 py-4 font-bold sortable-header">åˆ©æ½¤ <span v-if="sortKey === 'profit'">{{ sortOrder === 1 ? 'â–²' : 'â–¼' }}</span></th>
                            <th @click="sortBy('isPaid')" class="px-4 py-4 text-center font-bold sortable-header">ç‹€æ…‹ <span v-if="sortKey === 'isPaid'">{{ sortOrder === 1 ? 'â–²' : 'â–¼' }}</span></th>
                            <th class="px-4 py-4 text-center font-bold">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <tr v-for="(item, idx) in paginatedItems" :key="idx" class="hover:bg-slate-50 transition duration-150">
                            <td class="px-4 py-3 whitespace-nowrap font-mono text-xs text-slate-400">{{ item.date }}</td>
                            <td class="px-4 py-3"><div class="font-bold text-slate-700">{{ item.brand }}</div><div class="text-xs text-slate-500">{{ item.productName }} <span v-if="item.model" class="text-slate-400">({{ item.model }})</span></div></td>
                            <td class="px-4 py-3 text-slate-600">{{ item.customer }}</td>
                            <td class="px-4 py-3"><div class="flex flex-col gap-1 items-start"><span v-if="item.priceJPY" class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full whitespace-nowrap">åŸ {{ getCurrencySymbol(item.currency) }}{{ item.priceJPY }}</span><span v-if="item.priceDiscountJPY" class="text-[10px] bg-orange-50 text-orange-600 font-bold px-2 py-0.5 rounded-full whitespace-nowrap border border-orange-100">æŠ˜ {{ getCurrencySymbol(item.currency) }}{{ item.priceDiscountJPY }}</span><span v-if="item.priceTaxFreeJPY" class="text-[10px] bg-blue-50 text-blue-600 font-bold px-2 py-0.5 rounded-full whitespace-nowrap border border-blue-100">é€€ {{ getCurrencySymbol(item.currency) }}{{ item.priceTaxFreeJPY }}</span><span v-if="!item.priceJPY && !item.priceDiscountJPY && !item.priceTaxFreeJPY" class="text-slate-200 text-xs">-</span></div></td>
                            <td class="px-4 py-3 font-mono text-slate-600">{{ formatCurrency(item.priceTWD) }}</td>
                            <td class="px-4 py-3 font-mono text-slate-400">{{ item.shipping ? formatCurrency(item.shipping) : '-' }}</td>
                            <td class="px-4 py-3 font-mono font-bold text-indigo-600">{{ formatCurrency(item.quotePrice) }}</td>
                            <td class="px-4 py-3 font-mono font-bold text-emerald-600">+{{ formatCurrency(item.profit) }}</td>
                            <td class="px-4 py-3 text-center whitespace-nowrap"><span @click="togglePaid(item)" :class="item.isPaid ? 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200' : 'bg-rose-100 text-rose-700 ring-1 ring-rose-200'" class="cursor-pointer px-3 py-1 rounded-full text-xs font-bold select-none transition hover:opacity-80">{{ item.isPaid ? 'å·²ç¹³æ¸…' : 'æœªç¹³' }}</span></td>
                            <td class="px-4 py-3 text-center whitespace-nowrap"><button @click="editItem(item)" class="w-8 h-8 rounded-full hover:bg-indigo-50 text-indigo-300 hover:text-indigo-600 transition inline-flex items-center justify-center mr-1">âœ</button><button @click="deleteItem(item)" class="w-8 h-8 rounded-full hover:bg-rose-50 text-slate-300 hover:text-rose-500 transition inline-flex items-center justify-center">âœ•</button></td>
                        </tr>
                        <tr v-if="items.length === 0"><td colspan="10" class="px-6 py-12 text-center text-slate-400"><div class="text-4xl mb-2">ğŸ“‹</div>ç›®å‰æ²’æœ‰è¨‚å–®è³‡æ–™ï¼Œè«‹åœ¨ä¸Šæ–¹æ–°å¢</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- VIEW 2: CUSTOMERS ANALYSIS (REDESIGNED) -->
    <div v-if="currentView === 'customers'" class="animate-fade">
        <!-- 1. Top Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-panel p-6 bg-white border-l-4 border-indigo-500">
                <div class="text-indigo-400 text-sm font-medium mb-1">ç¸½å®¢æˆ¶æ•¸ (ä¸å«ç„¡åæ°)</div>
                <div class="text-3xl font-bold text-slate-800">{{ customerStats.length }} <span class="text-lg font-normal text-slate-400">äºº</span></div>
            </div>
            <div class="glass-panel p-6 bg-white border-l-4 border-amber-500">
                <div class="text-amber-500 text-sm font-medium mb-1">å¹³å‡å®¢å–®åƒ¹ (ç¸½é‡‘é¡/äºº)</div>
                <div class="text-3xl font-bold text-slate-800">
                    {{ customerStats.length ? formatCurrency(customerStats.reduce((sum,c)=>sum+c.totalSpent,0) / customerStats.length) : '-' }}
                </div>
            </div>
            <div class="glass-panel p-6 bg-white border-l-4 border-rose-500">
                <div class="text-rose-500 text-sm font-medium mb-1">æœ€é«˜é »ç‡é¡§å®¢</div>
                 <div class="truncate">
                    <div class="text-2xl font-bold text-slate-800">{{ customerStats.length ? [...customerStats].sort((a,b)=>b.orderCount-a.orderCount)[0].displayName : '-' }}</div>
                    <div class="text-sm text-slate-400" v-if="customerStats.length">ç´¯è¨ˆ {{ [...customerStats].sort((a,b)=>b.orderCount-a.orderCount)[0].orderCount }} ç­†è¨‚å–®</div>
                </div>
            </div>
        </div>

        <!-- 2. Top 3 Contributors Showcase -->
        <div v-if="customerStats.length > 0" class="mb-8">
            <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸ†</span> å¹´åº¦æ¶ˆè²»æ¦®è­½æ¦œ (Top 3)
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div v-for="(cust, idx) in sortedCustomerStats.slice(0, 3)" :key="cust.name" 
                     class="glass-panel p-6 flex flex-col items-center justify-center relative overflow-hidden"
                     :class="{'border-b-4 border-yellow-400': idx===0, 'border-b-4 border-slate-300': idx===1, 'border-b-4 border-orange-400': idx===2}">
                    
                    <div class="absolute top-0 right-0 p-2 opacity-10 text-6xl font-black">#{{idx+1}}</div>
                    <div class="w-16 h-16 rounded-full flex items-center justify-center text-2xl mb-3 shadow-md"
                         :class="{'bg-yellow-100 text-yellow-600': idx===0, 'bg-slate-100 text-slate-500': idx===1, 'bg-orange-100 text-orange-600': idx===2}">
                        {{ idx === 0 ? 'ğŸ¥‡' : (idx === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰') }}
                    </div>
                    <div class="text-xl font-bold text-slate-800 mb-1">{{ cust.displayName }}</div>
                    <div class="text-indigo-600 font-bold text-lg mb-1">{{ formatCurrency(cust.totalSpent) }}</div>
                    <div class="text-xs text-slate-400">åˆ©æ½¤è²¢ç»: {{ formatCurrency(cust.totalProfit) }}</div>
                </div>
            </div>
        </div>

        <!-- 3. Clean Customer Table -->
        <div class="glass-panel overflow-hidden bg-white">
            <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-slate-700">é¡§å®¢è©³ç´°åˆ—è¡¨</h3>
                <span class="text-xs text-slate-400">é»æ“Šæ¨™é¡Œå¯æ’åº</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="px-4 py-4 w-12 text-center">æ’å</th>
                            <th class="px-4 py-4 sortable-header" @click="sortCustomerBy('displayName')">é¡§å®¢å§“å <span v-if="custSortKey === 'displayName'">{{ custSortOrder === 1 ? 'â–²' : 'â–¼' }}</span></th>
                            <th class="px-4 py-4 text-right sortable-header" @click="sortCustomerBy('totalSpent')">ç¸½æ¶ˆè²»é‡‘é¡ <span v-if="custSortKey === 'totalSpent'">{{ custSortOrder === 1 ? 'â–²' : 'â–¼' }}</span></th>
                            <th class="px-4 py-4 text-right sortable-header" @click="sortCustomerBy('totalProfit')">è²¢ç»åˆ©æ½¤ <span v-if="custSortKey === 'totalProfit'">{{ custSortOrder === 1 ? 'â–²' : 'â–¼' }}</span></th>
                            <th class="px-4 py-4 text-right sortable-header" @click="sortCustomerBy('orderCount')">è¨‚å–®æ•¸ <span v-if="custSortKey === 'orderCount'">{{ custSortOrder === 1 ? 'â–²' : 'â–¼' }}</span></th>
                            <th class="px-4 py-4 text-right">æœ€è¿‘æ¶ˆè²»æ—¥</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <tr v-for="(cust, idx) in sortedCustomerStats" :key="cust.name" class="hover:bg-slate-50 transition">
                            <td class="px-4 py-3 text-center font-mono text-slate-400">{{ idx + 1 }}</td>
                            <td class="px-4 py-3 font-bold text-slate-700 text-base">{{ cust.displayName }}</td>
                            <td class="px-4 py-3 text-right font-mono text-indigo-600 font-bold">{{ formatCurrency(cust.totalSpent) }}</td>
                            <td class="px-4 py-3 text-right font-mono text-emerald-600">+{{ formatCurrency(cust.totalProfit) }}</td>
                            <td class="px-4 py-3 text-right font-mono">{{ cust.orderCount }}</td>
                            <td class="px-4 py-3 text-right font-mono text-xs text-slate-400">{{ cust.lastDate }}</td>
                        </tr>
                        <tr v-if="sortedCustomerStats.length === 0"><td colspan="6" class="text-center py-8 text-slate-400">å°šç„¡é¡§å®¢è³‡æ–™ (è«‹ç¢ºèªè¨‚å–®çš†æœ‰å¡«å¯«å§“å)</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            // State
            const currentView = ref('dashboard'); 
            const defaultItem = {
                brand: '', customer: '', productName: '', model: '',
                isPaid: false, date: new Date().toISOString().split('T')[0],
                currency: 'JPY', 
                priceJPY: '', priceDiscountJPY: '', priceTaxFreeJPY: '',
                priceTWD: '', quotePrice: '', shipping: '', profit: ''
            };

            const newItem = ref({ ...defaultItem });
            const items = ref([]);
            
            // Pagination & Sorting (Dashboard)
            const currentPage = ref(1);
            const itemsPerPage = ref(10);
            const sortKey = ref('');
            const sortOrder = ref(1);
            
            // Sorting (Customer)
            const custSortKey = ref('totalSpent');
            const custSortOrder = ref(-1);

            // Editing
            const isEditing = ref(false);
            const editingItemIndex = ref(null);
            
            // Currency
            const currencyList = ref(['JPY', 'THB']); 
            const newCurrencyInput = ref('');

            // Chart instances
            let brandChartInstance = null;
            let salesChartInstance = null;

            onMounted(() => {
                const savedData = localStorage.getItem('daigou_data');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    items.value = parsed.map(i => ({...i, currency: i.currency || 'JPY'}));
                }
                const savedCurrencies = localStorage.getItem('daigou_currencies');
                if (savedCurrencies) {
                    currencyList.value = JSON.parse(savedCurrencies);
                }
                setTimeout(renderCharts, 100);
            });

            // Watchers
            watch(items, (newVal) => {
                localStorage.setItem('daigou_data', JSON.stringify(newVal));
                if(currentView.value === 'dashboard') updateCharts();
                if (currentPage.value > totalPages.value && totalPages.value > 0) currentPage.value = totalPages.value;
            }, { deep: true });

            watch(currencyList, (newVal) => localStorage.setItem('daigou_currencies', JSON.stringify(newVal)), { deep: true });
            watch(itemsPerPage, () => currentPage.value = 1);
            watch(currentView, (newVal) => {
                if(newVal === 'dashboard') setTimeout(renderCharts, 100);
            });

            // --- Logic: Dashboard ---
            const sortBy = (key) => {
                if (sortKey.value === key) sortOrder.value *= -1;
                else { sortKey.value = key; sortOrder.value = 1; }
            };

            const sortedItems = computed(() => {
                let data = [...items.value];
                if (sortKey.value) {
                    data.sort((a, b) => {
                        let valA = a[sortKey.value], valB = b[sortKey.value];
                        if (!isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB))) { valA = parseFloat(valA); valB = parseFloat(valB); }
                        else { valA = (valA || '').toString().toLowerCase(); valB = (valB || '').toString().toLowerCase(); }
                        return (valA < valB ? -1 : 1) * sortOrder.value;
                    });
                }
                return data;
            });

            const totalPages = computed(() => Math.ceil(sortedItems.value.length / itemsPerPage.value));
            const paginatedItems = computed(() => {
                const start = (currentPage.value - 1) * itemsPerPage.value;
                return sortedItems.value.slice(start, start + itemsPerPage.value);
            });

            // --- Logic: Customer Analysis ---
            const normalizeName = (name) => name ? name.trim().toUpperCase() : '';
            
            const customerStats = computed(() => {
                const stats = {};
                
                items.value.forEach(item => {
                    const normName = normalizeName(item.customer);
                    if(!normName) return; // Skip empty names

                    if(!stats[normName]) {
                        stats[normName] = { 
                            name: normName, 
                            displayName: item.customer.trim(),
                            totalSpent: 0, 
                            totalProfit: 0, 
                            orderCount: 0, 
                            lastDate: item.date
                        };
                    }
                    stats[normName].totalSpent += parseFloat(item.quotePrice) || 0;
                    stats[normName].totalProfit += parseFloat(item.profit) || 0;
                    stats[normName].orderCount += 1;
                    if(item.date > stats[normName].lastDate) stats[normName].lastDate = item.date;
                });
                return Object.values(stats);
            });

            const sortCustomerBy = (key) => {
                if (custSortKey.value === key) custSortOrder.value *= -1;
                else { custSortKey.value = key; custSortOrder.value = -1; }
            };

            const sortedCustomerStats = computed(() => {
                return [...customerStats.value].sort((a, b) => {
                    let valA = a[custSortKey.value], valB = b[custSortKey.value];
                    if (typeof valA === 'string') {
                         valA = valA.toLowerCase(); valB = valB.toLowerCase();
                         return (valA < valB ? -1 : 1) * (custSortOrder.value * -1); 
                    }
                    return (valA - valB) * custSortOrder.value;
                });
            });

            // --- Helper Functions ---
            const addCurrency = () => {
                const code = newCurrencyInput.value.trim().toUpperCase();
                if (code && !currencyList.value.includes(code)) {
                    currencyList.value.push(code); newItem.value.currency = code; newCurrencyInput.value = '';
                } else if(currencyList.value.includes(code)) alert('å¹£åˆ¥å·²å­˜åœ¨');
            };

            const getCurrencySymbol = (code) => ({ 'JPY': 'Â¥', 'THB': 'à¸¿', 'USD': '$', 'EUR': 'â‚¬', 'KRW': 'â‚©', 'TWD': 'NT$' }[code] || code);
            const normalizeBrand = (brand) => brand ? brand.trim().toUpperCase() : 'å…¶ä»–';

            const calculateProfit = () => {
                const quote = parseFloat(newItem.value.quotePrice) || 0;
                const cost = parseFloat(newItem.value.priceTWD) || 0;
                const shipping = parseFloat(newItem.value.shipping) || 0;
                if (quote > 0) newItem.value.profit = quote - cost - shipping;
            };

            const handleItemSubmit = () => {
                if (!newItem.value.productName || !newItem.value.quotePrice) { alert('è«‹è‡³å°‘è¼¸å…¥ã€Œå“åã€èˆ‡ã€Œå ±åƒ¹ã€'); return; }
                if (isEditing.value && editingItemIndex.value !== null) {
                    items.value[editingItemIndex.value] = { ...newItem.value }; cancelEdit();
                } else {
                    items.value.unshift({ ...newItem.value });
                    const { date, currency } = newItem.value;
                    newItem.value = { ...defaultItem, date, currency };
                    if(!sortKey.value) currentPage.value = 1;
                }
            };

            const editItem = (item) => {
                const index = items.value.indexOf(item);
                if (index !== -1) {
                    editingItemIndex.value = index; newItem.value = { ...item }; isEditing.value = true;
                    document.getElementById('inputForm').scrollIntoView({ behavior: 'smooth' });
                }
            };

            const cancelEdit = () => {
                isEditing.value = false; editingItemIndex.value = null;
                const { date, currency } = newItem.value;
                newItem.value = { ...defaultItem, date, currency };
            };

            const deleteItem = (item) => { if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) { const index = items.value.indexOf(item); if (index !== -1) items.value.splice(index, 1); }};
            const togglePaid = (item) => { item.isPaid = !item.isPaid; };
            const clearAll = () => { if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) { items.value = []; currentPage.value = 1; }};

            const exportData = () => {
                const dataStr = JSON.stringify(items.value);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', 'ä»£è³¼è³‡æ–™å‚™ä»½_'+new Date().toISOString().slice(0,10)+'.json');
                link.click();
            };

            const fileInput = ref(null);
            const triggerFileInput = () => { fileInput.value.click(); };
            const importData = (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (Array.isArray(imported)) {
                            const processed = imported.map(i => ({...i, currency: i.currency || 'JPY'}));
                            if(confirm('åŒ¯å…¥å°‡æœƒè¦†è“‹ç›®å‰çš„è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ(è‹¥æƒ³åˆä½µè«‹é¸å–æ¶ˆ)')) items.value = processed;
                            else items.value = [...items.value, ...processed];
                            currentPage.value = 1;
                        } else alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                    } catch (err) { alert('ç„¡æ³•è®€å–æª”æ¡ˆ'); }
                };
                reader.readAsText(file); event.target.value = ''; 
            };

            // Stats & Charts
            const totalRevenue = computed(() => items.value.reduce((sum, item) => sum + (parseFloat(item.quotePrice) || 0), 0));
            const totalProfit = computed(() => items.value.reduce((sum, item) => sum + (parseFloat(item.profit) || 0), 0));
            const unpaidCount = computed(() => items.value.filter(item => !item.isPaid).length);
            const uniqueBrands = computed(() => [...new Set(items.value.map(i => normalizeBrand(i.brand)).filter(Boolean))]);

            const topSellingBrands = computed(() => {
                const stats = {};
                items.value.forEach(item => {
                    const b = normalizeBrand(item.brand);
                    if (!stats[b]) stats[b] = { name: b, count: 0 };
                    stats[b].count += 1;
                });
                return Object.values(stats).sort((a, b) => b.count - a.count).slice(0, 5);
            });

            const topProfitProducts = computed(() => {
                const stats = {};
                items.value.forEach(item => {
                    const b = normalizeBrand(item.brand);
                    const key = b + ' - ' + item.productName;
                    if (!stats[key]) stats[key] = { name: item.productName, brand: b, totalProfit: 0 };
                    stats[key].totalProfit += (parseFloat(item.profit) || 0);
                });
                return Object.values(stats).sort((a, b) => b.totalProfit - a.totalProfit).slice(0, 5);
            });

            const getRankClass = (idx) => { if (idx === 0) return 'rank-1'; if (idx === 1) return 'rank-2'; if (idx === 2) return 'rank-3'; return 'rank-other'; };
            const formatCurrency = (val) => { if (!val && val !== 0) return '-'; return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(val); };

            const renderCharts = () => {
                if(currentView.value !== 'dashboard') return;
                const ctxBrand = document.getElementById('brandChart');
                const ctxSales = document.getElementById('salesChart');
                if (!ctxBrand || !ctxSales) return;

                if(brandChartInstance) brandChartInstance.destroy();
                if(salesChartInstance) salesChartInstance.destroy();

                brandChartInstance = new Chart(ctxBrand, { type: 'doughnut', data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right' } } } });
                salesChartInstance = new Chart(ctxSales, { type: 'bar', data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }, plugins: { legend: { position: 'bottom' } } } });
                updateCharts();
            };

            const updateCharts = () => {
                if (!brandChartInstance || !salesChartInstance) return;
                
                const brandCounts = {};
                items.value.forEach(i => { const b = normalizeBrand(i.brand); brandCounts[b] = (brandCounts[b] || 0) + 1; });
                const sortedBrands = Object.entries(brandCounts).sort((a, b) => b[1] - a[1]);
                let finalLabels = [], finalData = [];
                if (sortedBrands.length > 5) {
                    const top5 = sortedBrands.slice(0, 5);
                    const othersSum = sortedBrands.slice(5).reduce((sum, item) => sum + item[1], 0);
                    finalLabels = top5.map(i => i[0]); finalData = top5.map(i => i[1]);
                    finalLabels.push('å…¶ä»– (Others)'); finalData.push(othersSum);
                } else { finalLabels = sortedBrands.map(i => i[0]); finalData = sortedBrands.map(i => i[1]); }
                
                brandChartInstance.data = { labels: finalLabels, datasets: [{ data: finalData, backgroundColor: ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6', '#94a3b8'], borderWidth: 0 }] };
                brandChartInstance.update();

                const monthlyData = {};
                items.value.forEach(i => {
                    if (!i.date) return;
                    const month = i.date.substring(0, 7); 
                    if (!monthlyData[month]) monthlyData[month] = { sales: 0, profit: 0 };
                    monthlyData[month].sales += (parseFloat(i.quotePrice) || 0);
                    monthlyData[month].profit += (parseFloat(i.profit) || 0);
                });
                const sortedMonths = Object.keys(monthlyData).sort();
                salesChartInstance.data = { labels: sortedMonths, datasets: [ { label: 'ç‡Ÿæ¥­é¡', data: sortedMonths.map(m => monthlyData[m].sales), backgroundColor: '#c7d2fe', borderRadius: 4 }, { label: 'æ·¨åˆ©æ½¤', data: sortedMonths.map(m => monthlyData[m].profit), backgroundColor: '#6366f1', borderRadius: 4 } ] };
                salesChartInstance.update();
            };

            return {
                currentView, newItem, items, handleItemSubmit, editItem, cancelEdit, deleteItem, togglePaid, clearAll,
                totalRevenue, totalProfit, unpaidCount, uniqueBrands, isEditing,
                formatCurrency, calculateProfit, exportData, importData, triggerFileInput, fileInput,
                topSellingBrands, topProfitProducts, getRankClass, currencyList, newCurrencyInput, addCurrency, getCurrencySymbol,
                currentPage, itemsPerPage, totalPages, paginatedItems, sortKey, sortOrder, sortBy,
                // Customer Analysis
                customerStats, sortedCustomerStats, sortCustomerBy, custSortKey, custSortOrder
            };
        }
    }).mount('#app');
</script>

</body>
</html>