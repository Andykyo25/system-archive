<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£è³¼æ˜ç´°çµ±è¨ˆç³»çµ±</title>
    <!-- Tailwind CSS (UIè¨­è¨ˆ) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js (åœ–è¡¨) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Vue.js 3 (é‚è¼¯) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .form-input {
            transition: all 0.3s ease;
        }
        .form-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.1), 0 2px 4px -1px rgba(99, 102, 241, 0.06);
        }
    </style>
</head>
<body class="text-gray-700">

<div id="app" class="min-h-screen p-4 md:p-8">

    <!-- Header & Controls -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-bold text-indigo-600 tracking-tight">ä»£è³¼æ˜ç´°çµ±è¨ˆç³»çµ±</h1>
            <p class="text-gray-500 text-sm mt-1">æ™ºæ…§åˆ†æèˆ‡åº«å­˜ç®¡ç†</p>
        </div>
        <div class="flex gap-3">
            <button @click="triggerFileInput" class="bg-white text-indigo-600 px-4 py-2 rounded-full shadow-sm hover:shadow-md transition font-medium border border-indigo-100 flex items-center gap-2">
                ğŸ“‚ åŒ¯å…¥æ•¸æ“š
            </button>
            <input type="file" ref="fileInput" class="hidden" @change="importData" accept=".json">
            
            <button @click="exportData" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-full shadow-sm hover:shadow-md transition font-medium border border-indigo-100 flex items-center gap-2">
                ğŸ’¾ åŒ¯å‡ºå‚™ä»½
            </button>
            <button @click="clearAll" class="bg-red-50 text-red-500 px-4 py-2 rounded-full shadow-sm hover:shadow-md transition font-medium border border-red-100">
                ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰
            </button>
        </div>
    </header>

    <!-- Dashboard Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="glass-panel p-6 rounded-2xl shadow-sm border-l-4 border-indigo-500">
            <div class="text-gray-400 text-sm font-medium mb-1">ç¸½ç‡Ÿæ¥­é¡ (å«é‹è²»)</div>
            <div class="text-3xl font-bold text-gray-800">{{ formatCurrency(totalRevenue) }}</div>
        </div>
        <div class="glass-panel p-6 rounded-2xl shadow-sm border-l-4 border-emerald-500">
            <div class="text-gray-400 text-sm font-medium mb-1">é ä¼°ç¸½åˆ©æ½¤</div>
            <div class="text-3xl font-bold text-emerald-600">{{ formatCurrency(totalProfit) }}</div>
        </div>
        <div class="glass-panel p-6 rounded-2xl shadow-sm border-l-4 border-orange-400">
            <div class="text-gray-400 text-sm font-medium mb-1">ç¸½è¨‚å–®æ•¸</div>
            <div class="text-3xl font-bold text-gray-800">{{ items.length }} <span class="text-sm font-normal text-gray-400">ç­†</span></div>
        </div>
        <div class="glass-panel p-6 rounded-2xl shadow-sm border-l-4 border-rose-500">
            <div class="text-gray-400 text-sm font-medium mb-1">æœªç¹³æ¸…æ¬¾é …</div>
            <div class="text-3xl font-bold text-rose-500">{{ unpaidCount }} <span class="text-sm font-normal text-gray-400">ç­†</span></div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <div class="glass-panel p-6 rounded-2xl shadow-lg bg-white">
            <h3 class="text-lg font-bold text-gray-700 mb-4">å“ç‰ŒéŠ·å”®ä½”æ¯”</h3>
            <div class="relative h-64">
                <canvas id="brandChart"></canvas>
            </div>
        </div>
        <div class="glass-panel p-6 rounded-2xl shadow-lg bg-white">
            <h3 class="text-lg font-bold text-gray-700 mb-4">æœˆåº¦éŠ·å”®åˆ©æ½¤è¶¨å‹¢</h3>
            <div class="relative h-64">
                <canvas id="salesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Input Form -->
    <div class="glass-panel p-6 rounded-2xl shadow-lg mb-8 bg-white">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="text-xl font-bold text-indigo-700">æ–°å¢è¨‚å–®</h2>
            <button @click="addItem" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-2 rounded-full shadow-lg transform active:scale-95 transition font-bold">
                ï¼‹ æ–°å¢è³‡æ–™
            </button>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            <!-- Basic Info -->
            <div class="col-span-1">
                <label class="text-xs font-bold text-gray-500 ml-1">ä¸‹å–®æ—¥æœŸ</label>
                <input type="date" v-model="newItem.date" class="form-input w-full mt-1 p-2 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:outline-none">
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-gray-500 ml-1">é¡§å®¢å§“å</label>
                <input type="text" v-model="newItem.customer" placeholder="è¼¸å…¥å§“å" class="form-input w-full mt-1 p-2 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:outline-none">
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-gray-500 ml-1">å“ç‰Œ</label>
                <input type="text" v-model="newItem.brand" list="brandList" placeholder="é¸æ“‡æˆ–è¼¸å…¥" class="form-input w-full mt-1 p-2 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:outline-none">
                <datalist id="brandList">
                    <option v-for="b in uniqueBrands" :value="b"></option>
                </datalist>
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-gray-500 ml-1">å“å</label>
                <input type="text" v-model="newItem.productName" placeholder="ç”¢å“åç¨±" class="form-input w-full mt-1 p-2 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:outline-none">
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-gray-500 ml-1">å‹è™Ÿ</label>
                <input type="text" v-model="newItem.model" placeholder="ex: A-101" class="form-input w-full mt-1 p-2 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:outline-none">
            </div>
            <div class="col-span-1 flex items-end">
                <label class="flex items-center space-x-2 cursor-pointer bg-gray-100 px-4 py-2 rounded-xl w-full h-[42px] border border-transparent hover:border-indigo-200 transition">
                    <input type="checkbox" v-model="newItem.isPaid" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500">
                    <span class="text-sm font-medium text-gray-700">å·²ç¹³æ¸…æ¬¾é …</span>
                </label>
            </div>

            <!-- Price Info JPY -->
            <div class="col-span-2 md:col-span-6 border-t my-2 border-dashed border-gray-200"></div>

            <div class="col-span-1">
                <label class="text-xs font-bold text-gray-500 ml-1">æ—¥å¹£åŸåƒ¹</label>
                <input type="number" v-model.number="newItem.priceJPY" class="form-input w-full mt-1 p-2 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:outline-none">
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-gray-500 ml-1">æŠ˜å¾Œæ—¥å¹£</label>
                <input type="number" v-model.number="newItem.priceDiscountJPY" class="form-input w-full mt-1 p-2 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:outline-none">
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-gray-500 ml-1">é€€ç¨…å¾Œæ—¥å¹£</label>
                <input type="number" v-model.number="newItem.priceTaxFreeJPY" class="form-input w-full mt-1 p-2 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:outline-none">
            </div>
            
            <!-- Price Info TWD -->
            <div class="col-span-1">
                <label class="text-xs font-bold text-indigo-400 ml-1">å°å¹£æˆæœ¬</label>
                <input type="number" v-model.number="newItem.priceTWD" @input="calculateProfit" class="form-input w-full mt-1 p-2 rounded-xl border border-indigo-100 bg-indigo-50 focus:bg-white focus:border-indigo-500 focus:outline-none font-medium">
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-gray-500 ml-1">é‹è²» (TWD)</label>
                <input type="number" v-model.number="newItem.shipping" @input="calculateProfit" placeholder="å®¢äººä»˜å‰‡å¡«å¯«" class="form-input w-full mt-1 p-2 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:outline-none">
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-indigo-600 ml-1">å ±åƒ¹ (TWD)</label>
                <input type="number" v-model.number="newItem.quotePrice" @input="calculateProfit" class="form-input w-full mt-1 p-2 rounded-xl border-2 border-indigo-100 bg-white focus:border-indigo-500 focus:outline-none font-bold text-indigo-700">
            </div>
            <div class="col-span-2 md:col-span-6 flex justify-end">
                 <div class="bg-emerald-50 px-4 py-2 rounded-xl border border-emerald-100 flex items-center gap-2">
                    <span class="text-xs text-emerald-600 font-bold">é ä¼°åˆ©æ½¤</span>
                    <input type="number" v-model.number="newItem.profit" class="bg-transparent font-bold text-emerald-600 outline-none w-24 text-right" placeholder="0">
                 </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="glass-panel rounded-2xl shadow-lg overflow-hidden bg-white">
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                    <tr>
                        <th class="px-4 py-3">æ—¥æœŸ</th>
                        <th class="px-4 py-3">å“ç‰Œ/å“å</th>
                        <th class="px-4 py-3">é¡§å®¢</th>
                        <th class="px-4 py-3">æ—¥å¹£(é€€ç¨…)</th>
                        <th class="px-4 py-3">å°å¹£æˆæœ¬</th>
                        <th class="px-4 py-3">é‹è²»(å®¢ä»˜)</th>
                        <th class="px-4 py-3">å ±åƒ¹</th>
                        <th class="px-4 py-3">åˆ©æ½¤</th>
                        <th class="px-4 py-3 text-center">ç‹€æ…‹</th>
                        <th class="px-4 py-3 text-center">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(item, index) in items" :key="index" class="border-b hover:bg-gray-50 transition">
                        <td class="px-4 py-3 whitespace-nowrap font-mono text-xs">{{ item.date }}</td>
                        <td class="px-4 py-3">
                            <div class="font-bold text-gray-800">{{ item.brand }}</div>
                            <div class="text-xs text-gray-400">{{ item.productName }} <span v-if="item.model">({{ item.model }})</span></div>
                        </td>
                        <td class="px-4 py-3">{{ item.customer }}</td>
                        <td class="px-4 py-3 font-mono">Â¥{{ item.priceTaxFreeJPY || item.priceDiscountJPY || item.priceJPY }}</td>
                        <td class="px-4 py-3 font-mono">{{ formatCurrency(item.priceTWD) }}</td>
                        <td class="px-4 py-3 font-mono text-gray-400">{{ item.shipping ? formatCurrency(item.shipping) : '-' }}</td>
                        <td class="px-4 py-3 font-mono font-bold text-indigo-600">{{ formatCurrency(item.quotePrice) }}</td>
                        <td class="px-4 py-3 font-mono text-emerald-600">+{{ formatCurrency(item.profit) }}</td>
                        <td class="px-4 py-3 text-center">
                            <span @click="togglePaid(index)" :class="item.isPaid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="cursor-pointer px-2 py-1 rounded-full text-xs font-medium select-none">
                                {{ item.isPaid ? 'å·²ç¹³æ¸…' : 'æœªç¹³' }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button @click="deleteItem(index)" class="text-red-400 hover:text-red-600 transition">âœ•</button>
                        </td>
                    </tr>
                    <tr v-if="items.length === 0">
                        <td colspan="10" class="px-6 py-10 text-center text-gray-400">
                            å°šç„¡è³‡æ–™ï¼Œè«‹ç”±ä¸Šæ–¹æ–°å¢è¨‚å–®
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            // è³‡æ–™çµæ§‹
            const defaultItem = {
                brand: '', customer: '', productName: '', model: '',
                isPaid: false, date: new Date().toISOString().split('T')[0],
                priceJPY: '', priceDiscountJPY: '', priceTaxFreeJPY: '',
                priceTWD: '', quotePrice: '', shipping: '', profit: ''
            };

            const newItem = ref({ ...defaultItem });
            const items = ref([]);
            
            // Chart instances
            let brandChartInstance = null;
            let salesChartInstance = null;

            // åˆå§‹åŒ–
            onMounted(() => {
                const savedData = localStorage.getItem('daigou_data');
                if (savedData) {
                    items.value = JSON.parse(savedData);
                }
                renderCharts();
            });

            // ç›£è½æ•¸æ“šè®ŠåŒ–ä»¥ä¿å­˜å’Œæ›´æ–°åœ–è¡¨
            watch(items, (newVal) => {
                localStorage.setItem('daigou_data', JSON.stringify(newVal));
                updateCharts();
            }, { deep: true });

            // è¨ˆç®—åˆ©æ½¤é‚è¼¯ (ä¿®æ”¹é»ï¼šé‹è²»è‹¥æœ‰è¼¸å…¥ä»£è¡¨å®¢ä»˜ï¼Œä¸æ‰£åˆ©æ½¤)
            const calculateProfit = () => {
                const quote = parseFloat(newItem.value.quotePrice) || 0;
                const cost = parseFloat(newItem.value.priceTWD) || 0;
                
                // å…¬å¼ï¼šåˆ©æ½¤ = å ±åƒ¹ - æˆæœ¬
                // è‹¥æœ‰é‹è²»ï¼Œä»£è¡¨æ”¶å…¥å¢åŠ é‹è²»ï¼Œæ”¯å‡ºå¢åŠ é‹è²»ï¼Œäº’ç›¸æŠµéŠ·ï¼Œæ•…åˆ©æ½¤ä¸è®Š
                // è‹¥ç„¡é‹è²»ï¼Œä»£è¡¨å¸æ”¶ï¼Œé€™è£¡ä¸è¨ˆç®—å¸æ”¶çš„æˆæœ¬(å› ç‚ºè¼¸å…¥ç‚º0æˆ–ç©º)ï¼Œä¾èˆŠæ˜¯ å ±åƒ¹-æˆæœ¬
                if (quote > 0) {
                    newItem.value.profit = quote - cost;
                }
            };

            const addItem = () => {
                if (!newItem.value.productName || !newItem.value.quotePrice) {
                    alert('è«‹è‡³å°‘è¼¸å…¥ã€Œå“åã€èˆ‡ã€Œå ±åƒ¹ã€');
                    return;
                }
                items.value.unshift({ ...newItem.value });
                // Reset form but keep date
                const currentDate = newItem.value.date;
                newItem.value = { ...defaultItem, date: currentDate };
            };

            const deleteItem = (index) => {
                if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) {
                    items.value.splice(index, 1);
                }
            };

            const togglePaid = (index) => {
                items.value[index].isPaid = !items.value[index].isPaid;
            };

            const clearAll = () => {
                if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    items.value = [];
                }
            };

            // åŒ¯å‡ºåŒ¯å…¥
            const exportData = () => {
                const dataStr = JSON.stringify(items.value);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'ä»£è³¼è³‡æ–™å‚™ä»½_'+new Date().toISOString().slice(0,10)+'.json';
                
                let linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };

            const fileInput = ref(null);
            const triggerFileInput = () => {
                fileInput.value.click();
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (Array.isArray(imported)) {
                            if(confirm('åŒ¯å…¥å°‡æœƒè¦†è“‹ç›®å‰çš„è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ(è‹¥æƒ³åˆä½µè«‹é¸å–æ¶ˆï¼Œæˆ‘æœƒå¹«ä½ åŠ åœ¨å¾Œé¢)')) {
                                items.value = imported;
                            } else {
                                items.value = [...items.value, ...imported];
                            }
                        } else {
                            alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                        }
                    } catch (err) {
                        alert('ç„¡æ³•è®€å–æª”æ¡ˆ');
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // reset
            };

            // çµ±è¨ˆæ•¸æ“š (ä¿®æ”¹é»ï¼šç¸½ç‡Ÿæ¥­é¡ = å ±åƒ¹ + é‹è²»(å®¢ä»˜))
            const totalRevenue = computed(() => items.value.reduce((sum, item) => sum + (parseFloat(item.quotePrice) || 0) + (parseFloat(item.shipping) || 0), 0));
            const totalProfit = computed(() => items.value.reduce((sum, item) => sum + (parseFloat(item.profit) || 0), 0));
            const unpaidCount = computed(() => items.value.filter(item => !item.isPaid).length);
            const uniqueBrands = computed(() => [...new Set(items.value.map(item => item.brand).filter(Boolean))]);

            // Helper
            const formatCurrency = (val) => {
                if (!val && val !== 0) return '-';
                return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(val);
            };

            // åœ–è¡¨é‚è¼¯
            const renderCharts = () => {
                const ctxBrand = document.getElementById('brandChart');
                const ctxSales = document.getElementById('salesChart');
                
                if (!ctxBrand || !ctxSales) return;

                // å“ç‰Œåœ–è¡¨
                brandChartInstance = new Chart(ctxBrand, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
                });

                // éŠ·å”®åœ–è¡¨
                salesChartInstance = new Chart(ctxSales, {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
                
                updateCharts();
            };

            const updateCharts = () => {
                if (!brandChartInstance || !salesChartInstance) return;

                // 1. è™•ç†å“ç‰Œæ•¸æ“š
                const brandCounts = {};
                items.value.forEach(i => {
                    const b = i.brand || 'æœªåˆ†é¡';
                    brandCounts[b] = (brandCounts[b] || 0) + 1;
                });
                
                brandChartInstance.data = {
                    labels: Object.keys(brandCounts),
                    datasets: [{
                        data: Object.values(brandCounts),
                        backgroundColor: [
                            '#6366f1', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6', '#3b82f6'
                        ],
                        borderWidth: 0
                    }]
                };
                brandChartInstance.update();

                // 2. è™•ç†æœˆåº¦æ•¸æ“š (ä¿®æ”¹é»ï¼šéŠ·å”®é¡å«é‹è²»)
                const monthlyData = {};
                items.value.forEach(i => {
                    if (!i.date) return;
                    const month = i.date.substring(0, 7); // YYYY-MM
                    if (!monthlyData[month]) monthlyData[month] = { sales: 0, profit: 0 };
                    
                    // éŠ·å”®é¡ = å ±åƒ¹ + é‹è²»(è‹¥æœ‰)
                    monthlyData[month].sales += (parseFloat(i.quotePrice) || 0) + (parseFloat(i.shipping) || 0);
                    monthlyData[month].profit += (parseFloat(i.profit) || 0);
                });

                const sortedMonths = Object.keys(monthlyData).sort();
                
                salesChartInstance.data = {
                    labels: sortedMonths,
                    datasets: [
                        {
                            label: 'ç‡Ÿæ¥­é¡(å«é‹è²»)',
                            data: sortedMonths.map(m => monthlyData[m].sales),
                            backgroundColor: '#c7d2fe',
                            borderRadius: 4
                        },
                        {
                            label: 'åˆ©æ½¤',
                            data: sortedMonths.map(m => monthlyData[m].profit),
                            backgroundColor: '#6366f1',
                            borderRadius: 4
                        }
                    ]
                };
                salesChartInstance.update();
            };

            return {
                newItem, items, addItem, deleteItem, togglePaid, clearAll,
                totalRevenue, totalProfit, unpaidCount, uniqueBrands,
                formatCurrency, calculateProfit,
                exportData, importData, triggerFileInput, fileInput
            };
        }
    }).mount('#app');
</script>

</body>
</html>