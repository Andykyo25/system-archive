<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS è²»ç”¨è¦–è¦ºåŒ– (V15 çµ±è¨ˆç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; background-color: #f8fafc; }
        
        .bg-gradient-brand { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
        
        .card { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.3s ease;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .drag-area { border: 2px dashed #a78bfa; background-color: #f5f3ff; transition: all 0.2s; }
        .drag-area:hover, .drag-area.active { border-color: #7c3aed; background-color: #ede9fe; transform: scale(1.01); }

        .trend-up { color: #f43f5e; font-weight: 700; } 
        .trend-down { color: #10b981; font-weight: 700; }
        
        .month-btn { transition: all 0.2s; border: 1px solid #e2e8f0; }
        .month-btn:hover { background-color: #f1f5f9; }
        .month-btn.active { background-color: #6366f1; color: white; border-color: #6366f1; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3); }

        .view-switch {
            background: #f1f5f9; border-radius: 999px; padding: 4px; display: flex; align-items: center; border: 1px solid #e2e8f0;
        }
        .view-btn {
            padding: 6px 16px; border-radius: 999px; font-size: 13px; font-weight: 600; color: #64748b; transition: all 0.3s;
        }
        .view-btn.active {
            background: white; color: #6366f1; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* è¡¨æ ¼å›ºå®šè¡¨é ­ */
        .detail-table th { position: sticky; top: 0; background: #f8fafc; z-index: 10; font-size: 11px; text-transform: uppercase; color: #64748b; padding: 12px; border-bottom: 2px solid #e2e8f0; }
        .detail-table td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .detail-table tr:hover { background-color: #f8fafc; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c4b5fd; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a78bfa; }
    </style>
    <script id="preloaded-data">window.PRELOADED_DATA = null;</script>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden">

    <!-- é ‚éƒ¨å°èˆª -->
    <div class="bg-white/90 backdrop-blur-md border-b border-indigo-100 sticky top-0 z-50 shadow-sm flex-none">
        <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-4">
            
            <div class="flex items-center gap-3 w-full md:w-auto">
                <div class="bg-gradient-brand text-white p-2.5 rounded-xl shadow-lg shadow-indigo-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight">AWS è²»ç”¨è¦–è¦ºåŒ– <span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full ml-1">V15</span></h1>
                    <p class="text-xs text-slate-500 font-medium">çµ±è¨ˆåˆ†æç‰ˆ</p>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-4 w-full md:w-auto justify-end" id="control-panel">
                
                <!-- è¦–è§’åˆ‡æ›å™¨ -->
                <div class="view-switch">
                    <button onclick="switchView('dashboard')" id="btn-dashboard" class="view-btn active">ğŸ“Š ç®¡ç†ç¸½è¦½</button>
                    <button onclick="switchView('detail')" id="btn-detail" class="view-btn">ğŸ” ç´°é …æ¯”å°</button>
                </div>

                <div class="h-6 w-px bg-slate-200"></div>

                <button onclick="exportReport()" class="h-9 px-3 bg-slate-800 hover:bg-slate-900 text-white rounded-lg text-xs font-bold transition">åŒ¯å‡ºå ±è¡¨</button>
                <button onclick="clearAllData()" class="h-9 px-3 border border-red-200 text-red-500 hover:bg-red-50 rounded-lg text-xs font-bold transition">æ¸…é™¤</button>
                
                <div id="drop-zone" class="drag-area relative w-36 h-9 rounded-lg flex items-center justify-center cursor-pointer group">
                    <input type="file" id="fileInput" accept=".csv" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    <div class="flex items-center gap-2 text-xs font-bold text-indigo-500 group-hover:text-indigo-700 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <span>åŒ¯å…¥ CSV</span>
                    </div>
                </div>
                <button onclick="document.getElementById('manual-panel').classList.toggle('hidden')" class="h-9 px-3 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded-lg text-xs font-bold transition">+ æ‰‹å‹•</button>
            </div>
        </div>
        
        <div id="manual-panel" class="hidden bg-slate-50 border-b border-indigo-100 p-4 animate-fade-in">
            <div class="max-w-7xl mx-auto flex flex-wrap items-center gap-3">
                <span class="text-xs font-bold bg-slate-200 text-slate-600 px-2 py-1 rounded">æ‰‹å‹•è¼¸å…¥</span>
                <input type="month" id="man-month" class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm">
                <input type="number" id="man-mix" placeholder="MIX é‡‘é¡" class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm w-32">
                <input type="number" id="man-prd" placeholder="PRD é‡‘é¡" class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm w-32">
                <div class="flex items-center gap-2 text-xs text-slate-500 ml-4"><input type="checkbox" id="use-big5"><label for="use-big5">Big5</label></div>
                <button onclick="addManualData()" class="px-4 py-1.5 bg-indigo-600 text-white text-sm rounded-lg font-bold hover:bg-indigo-700 shadow ml-auto">ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-50/50">
        
        <!-- Empty State -->
        <div id="empty-state" class="flex flex-col items-center justify-center py-24 text-center">
            <div class="w-24 h-24 bg-white rounded-full shadow-xl flex items-center justify-center mb-6 animate-bounce">
                <span class="text-5xl">ğŸ“Š</span>
            </div>
            <h2 class="text-3xl font-bold text-slate-800 mb-2">è³‡æ–™è¼‰å…¥èˆ‡æ™ºèƒ½åˆ†æ</h2>
            <p class="text-slate-500 max-w-md mx-auto">åŒ¯å…¥å¸³å–®å¾Œï¼Œå¯åˆ‡æ›è‡³ã€Œç´°é …æ¯”å°ã€æŸ¥çœ‹å…·é«”è²»ç”¨å¢æ¸›é …ç›®ã€‚</p>
        </div>

        <!-- VIEW 1: ç®¡ç†ç¸½è¦½ -->
        <div id="view-dashboard" class="hidden max-w-7xl mx-auto space-y-8 pb-10 animate-fade-in">
            
            <!-- KPI -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                <div class="card p-6 relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 w-24 h-24 bg-indigo-50 rounded-full group-hover:scale-110 transition duration-500"></div>
                    <p class="text-xs font-bold text-indigo-500 uppercase tracking-wider relative z-10">å¹´åº¦ç¸½æ”¯å‡º</p>
                    <h3 class="text-3xl font-bold text-slate-800 mt-2 relative z-10" id="kpi-total">-</h3>
                    <div class="mt-2 text-xs text-slate-400 relative z-10">Total Cost (NTD)</div>
                </div>
                <div class="card p-6 relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 w-24 h-24 bg-purple-50 rounded-full group-hover:scale-110 transition duration-500"></div>
                    <p class="text-xs font-bold text-purple-500 uppercase tracking-wider relative z-10">PRD ç’°å¢ƒä½”æ¯”</p>
                    <h3 class="text-3xl font-bold text-slate-800 mt-2 relative z-10" id="kpi-ratio">-</h3>
                    <div class="mt-2 text-xs text-slate-400 relative z-10">Production Usage</div>
                </div>
                <div class="card p-6 relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 w-24 h-24 bg-pink-50 rounded-full group-hover:scale-110 transition duration-500"></div>
                    <p class="text-xs font-bold text-pink-500 uppercase tracking-wider relative z-10">æœ€è²´æœå‹™</p>
                    <h3 class="text-2xl font-bold text-slate-800 mt-2 truncate relative z-10" id="kpi-top-svc">-</h3>
                    <div class="mt-2 text-xs text-slate-400 relative z-10">Highest Spend Service</div>
                </div>
                <div class="card p-6 relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 w-24 h-24 bg-orange-50 rounded-full group-hover:scale-110 transition duration-500"></div>
                    <p class="text-xs font-bold text-orange-500 uppercase tracking-wider relative z-10">æœ€é«˜æœˆè²»</p>
                    <h3 class="text-2xl font-bold text-slate-800 mt-2 relative z-10" id="kpi-max-month">-</h3>
                    <div class="mt-2 text-xs text-slate-400 relative z-10">Peak Spending Month</div>
                </div>
            </div>

            <!-- Trend Chart -->
            <div class="card p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <span class="text-2xl">ğŸ“ˆ</span> æœˆåº¦è²»ç”¨è¶¨å‹¢
                    </h3>
                    <div id="month-selector" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="h-80"><canvas id="trendChart"></canvas></div>
            </div>

            <!-- NEW: Pie Charts Section (Replaces Deep Dive & Diagnosis) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Service Distribution -->
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2 mb-4">
                        <span class="text-xl">ğŸ°</span> æœå‹™è²»ç”¨ä½”æ¯” (Top Services)
                    </h3>
                    <div class="h-64 relative flex justify-center">
                        <canvas id="servicePieChart"></canvas>
                    </div>
                </div>

                <!-- Environment Distribution -->
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2 mb-4">
                        <span class="text-xl">â˜¯ï¸</span> ç’°å¢ƒè²»ç”¨ä½”æ¯” (MIX vs PRD)
                    </h3>
                    <div class="h-64 relative flex justify-center">
                        <canvas id="envPieChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="card overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800">ğŸ“‹ æœˆåº¦è©³ç´°å ±è¡¨</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-right whitespace-nowrap">
                        <thead class="bg-slate-100/80 text-slate-500 font-bold uppercase text-[10px] tracking-wider">
                            <tr><th class="px-6 py-3 text-left">æœˆä»½</th><th>MIX</th><th>PRD</th><th>MIX å·®</th><th>PRD å·®</th><th class="bg-indigo-50 text-indigo-900">ç¸½é‡‘é¡</th><th>ç¸½å·®ç•° (MoM)</th><th class="text-center">æ“ä½œ</th></tr>
                        </thead>
                        <tbody id="report-table-body" class="divide-y divide-slate-100 bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW 2: ç´°é …æ¯”å°åˆ†æ -->
        <div id="view-detail" class="hidden max-w-7xl mx-auto h-full flex flex-col gap-4 animate-fade-in">
            
            <!-- Toolbar -->
            <div class="card p-4 flex flex-wrap items-center gap-4 bg-white sticky top-0 z-10">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-slate-400 uppercase">æ¯”è¼ƒå€é–“</span>
                    <select id="dt-month-curr" class="text-sm font-bold text-indigo-600 bg-indigo-50 border-none rounded px-3 py-1.5 cursor-pointer outline-none hover:bg-indigo-100 transition" onchange="renderDetailView()"></select>
                    <span class="text-slate-400">vs</span>
                    <select id="dt-month-prev" class="text-sm font-bold text-slate-600 bg-slate-100 border-none rounded px-3 py-1.5 cursor-pointer outline-none hover:bg-slate-200 transition" onchange="renderDetailView()"></select>
                </div>
                <div class="h-6 w-px bg-slate-200"></div>
                <div class="flex items-center gap-2 flex-1">
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input type="text" id="dt-search" placeholder="æœå°‹æœå‹™ (å¦‚ EC2), é—œéµå­—, ç’°å¢ƒ..." class="text-sm w-full outline-none text-slate-600 placeholder-slate-300" oninput="renderDetailView()">
                </div>
                <div class="flex gap-2 text-xs">
                    <div class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg font-bold border border-red-100" id="dt-stat-inc">å¢åŠ : $0</div>
                    <div class="bg-green-50 text-green-600 px-3 py-1.5 rounded-lg font-bold border border-green-100" id="dt-stat-dec">æ¸›å°‘: $0</div>
                </div>
            </div>

            <!-- Detail Table -->
            <div class="card flex-1 overflow-hidden flex flex-col shadow-sm">
                <div class="overflow-auto flex-1 custom-scrollbar">
                    <table class="w-full text-left detail-table whitespace-nowrap">
                        <thead>
                            <tr>
                                <th>ç’°å¢ƒ</th>
                                <th>æœå‹™ (Service)</th>
                                <th>ç´°é … (Usage Type)</th>
                                <th class="text-right cursor-pointer hover:text-indigo-600" onclick="dtSort='usage';renderDetailView()">ç”¨é‡å·®ç•° â†•</th>
                                <th class="text-right">æœ¬æœˆè²»ç”¨</th>
                                <th class="text-right">ä¸Šæœˆè²»ç”¨</th>
                                <th class="text-right cursor-pointer hover:text-indigo-600" onclick="dtSort='diff';renderDetailView()">è²»ç”¨å·®ç•° ($) â–¼</th>
                                <th class="text-right">è®ŠåŒ–å¹…åº¦ (%)</th>
                            </tr>
                        </thead>
                        <tbody id="dt-table-body" class="bg-white divide-y divide-slate-100"></tbody>
                    </table>
                </div>
                <div class="p-3 text-center text-xs text-slate-400 border-t border-slate-100 bg-slate-50" id="dt-footer">
                    è«‹é¸æ“‡æœˆä»½é€²è¡Œæ¯”å°
                </div>
            </div>
        </div>

    </div>

    <!-- Modal -->
    <div id="detail-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 class="font-bold text-lg text-slate-800" id="modal-title">åˆ†æ</h3>
                <button onclick="document.getElementById('detail-modal').classList.add('hidden')" class="text-2xl text-slate-400 hover:text-red-500">&times;</button>
            </div>
            <div id="modal-content-area" class="p-6 overflow-y-auto space-y-6"></div>
        </div>
    </div>

<script>
    Chart.defaults.font.family = "'Noto Sans TC', sans-serif";
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.maintainAspectRatio = false;
    
    let yearlyData = {}, allServices = new Set(), charts = {}, activeMonths = new Set();
    let dtSort = 'diff';

    const fmt = n => new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 }).format(n);
    const fmtUSD = n => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n);
    const fmtDiff = n => (n > 0 ? '+' : '') + fmtUSD(n);
    const getDiffClass = n => n > 100 ? 'trend-up' : (n < -100 ? 'trend-down' : 'text-slate-300 font-bold');
    const fmtPct = (a, b) => {
        if(b===0) return a>0 ? 'New' : '-';
        const p = ((a-b)/b)*100;
        return (p>0?'+':'') + p.toFixed(1) + '%';
    };

    window.onload = function() {
        if (window.PRELOADED_DATA) {
            yearlyData = window.PRELOADED_DATA;
            document.getElementById('control-panel').innerHTML = '<span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-2 rounded-lg">å”¯è®€å ±è¡¨æ¨¡å¼</span>';
            initData();
        } else {
            const cached = localStorage.getItem('aws_dashboard_v15_data');
            if (cached) { try { yearlyData = JSON.parse(cached); initData(); } catch(e) {} }
        }
    };

    const initData = () => {
        if(Object.keys(yearlyData).length === 0) return;
        rebuildServicesSet();
        updateDTOptions();
        renderDashboard();
    };

    window.switchView = (view) => {
        document.getElementById('view-dashboard').classList.add('hidden');
        document.getElementById('view-detail').classList.add('hidden');
        document.getElementById('btn-dashboard').classList.remove('active');
        document.getElementById('btn-detail').classList.remove('active');
        document.getElementById('view-' + view).classList.remove('hidden');
        document.getElementById('btn-' + view).classList.add('active');
        if(view === 'detail') renderDetailView();
    };

    const handleFiles = async (files) => {
        if (!files.length) return;
        const enc = document.getElementById('use-big5').checked ? 'Big5' : 'UTF-8';
        const promises = Array.from(files).map(f => new Promise(res => {
            Papa.parse(f, { encoding: enc, complete: r => { processFile(f.name, r.data); res(); }, error: res });
        }));
        await Promise.all(promises);
        saveData(); initData();
    };

    const findCostValue = (row) => {
        for (let i = row.length - 1; i >= 0; i--) {
            const str = (row[i] || "").toString().trim().replace(/,/g, '');
            if (!str) continue;
            const val = parseFloat(str);
            if (!isNaN(val)) return val;
        }
        return 0;
    };

    const processFile = (fname, rows) => {
        let env='MIX', m=null, tot=0, items=[], currSvc=null;
        for(let i=0; i<Math.min(rows.length,30); i++){
            const s = rows[i].join('||').toUpperCase().replace(/\s/g,'');
            if(s.includes('BILLINGPERIOD')){ const mat=s.match(/(\d{4}-\d{2})/); if(mat) m=mat[1]; }
            if((s.includes('ACCOUNTID')||s.includes('CUSTOMER')) && (s.includes('PRD')||s.includes('PROD'))) env='PRD';
            if(s.includes('TOTALAMOUNTOFPAYMENT') && !s.includes('(USD)')) {
                const nums=rows[i].map(c=>!c?0:parseFloat(c.toString().replace(/,/g,''))).filter(n=>!isNaN(n));
                if(nums.length) tot=Math.max(...nums);
            }
        }
        if(!m){ const mat=fname.match(/(\d{4}-\d{2})/); if(mat) m=mat[1]; }
        if(!m) return;
        rows.forEach(r => {
            const c0 = (r[0]||"").toString().trim();
            const v = findCostValue(r);
            if(c0.startsWith("Amazon") && v > 0) { currSvc = c0; allServices.add(c0); }
            if(currSvc && c0!=="UsageType" && c0 && !c0.includes("Total") && v > 0) {
                let usage = 0;
                const uVal = parseFloat((r[r.length-2]||"0").toString().replace(/,/g,''));
                if(!isNaN(uVal)) usage = uVal;
                items.push({s:currSvc, t:c0, c:v, u: usage});
            }
        });
        if(!yearlyData[m]) yearlyData[m]={mix:0, prd:0, mixI:[], prdI:[], man:false};
        if(env==='PRD'){ yearlyData[m].prd=tot; yearlyData[m].prdI=items; }
        else{ yearlyData[m].mix=tot; yearlyData[m].mixI=items; }
    };

    const addManualData = () => {
        const m=document.getElementById('man-month').value;
        const mix=parseFloat(document.getElementById('man-mix').value)||0;
        const prd=parseFloat(document.getElementById('man-prd').value)||0;
        if(!m) return alert('è«‹é¸æ“‡æœˆä»½');
        if(!yearlyData[m]) yearlyData[m]={mix:0, prd:0, mixI:[], prdI:[], man:true};
        yearlyData[m].mix=mix; yearlyData[m].prd=prd; yearlyData[m].man=true;
        saveData(); initData();
    };

    const rebuildServicesSet = () => {
        allServices = new Set();
        Object.values(yearlyData).forEach(m => { [...m.mixI, ...m.prdI].forEach(i => allServices.add(i.s)); });
    };
    
    const saveData = () => { if (!window.PRELOADED_DATA) localStorage.setItem('aws_dashboard_v15_data', JSON.stringify(yearlyData)); };
    const clearAllData = () => { if(confirm("ç¢ºå®šæ¸…é™¤ï¼Ÿ")) { localStorage.removeItem('aws_dashboard_v15_data'); location.reload(); } };
    const exportReport = () => {
        let html = document.documentElement.outerHTML;
        const dataScript = `window.PRELOADED_DATA = ${JSON.stringify(yearlyData)};`;
        const searchStr = 'window.PRELOADED_DATA = null;';
        if (html.includes(searchStr)) {
            html = html.replace(searchStr, dataScript);
            const blob = new Blob([html], { type: 'text/html' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `AWS_Report_${new Date().toISOString().slice(0,10)}.html`; a.click();
        } else alert("åŒ¯å‡ºå¤±æ•—");
    };

    // --- Dashboard Logic ---
    const renderDashboard = () => {
        const ms = Object.keys(yearlyData).sort();
        if(!ms.length) return;
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('view-dashboard').classList.remove('hidden');
        
        const displayMs = activeMonths.size === 0 ? ms : ms.filter(m => activeMonths.has(m));
        
        let gTot=0, pTot=0, maxV=0, maxM='', svcMap={};
        displayMs.forEach(m => { 
            const t=yearlyData[m].mix+yearlyData[m].prd;
            gTot+=t; pTot+=yearlyData[m].prd; 
            if(t>maxV){ maxV=t; maxM=m; }
            [...yearlyData[m].mixI, ...yearlyData[m].prdI].forEach(i=>{ svcMap[i.s]=(svcMap[i.s]||0)+i.c; });
        });
        const topSvc = Object.entries(svcMap).sort((a,b)=>b[1]-a[1])[0];

        document.getElementById('kpi-total').innerText = "$"+fmt(gTot);
        document.getElementById('kpi-ratio').innerText = gTot?Math.round((pTot/gTot)*100)+"%":"0%";
        document.getElementById('kpi-top-svc').innerText = topSvc?topSvc[0].replace('Amazon',''):'-';
        document.getElementById('kpi-max-month').innerText = maxM;

        const ctx = document.getElementById('trendChart').getContext('2d');
        if(charts.trend) charts.trend.destroy();
        charts.trend = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: displayMs,
                datasets: [
                    { label: 'MIX', data: displayMs.map(m=>yearlyData[m].mix), backgroundColor: '#a5b4fc', borderRadius:4, order: 2 },
                    { label: 'PRD', data: displayMs.map(m=>yearlyData[m].prd), backgroundColor: '#8b5cf6', borderRadius:4, order: 2 },
                    { 
                        label: 'ç¸½æ”¯å‡º', data: displayMs.map(m=>yearlyData[m].mix+yearlyData[m].prd), type:'line', 
                        borderColor: '#334155', borderWidth: 3, tension: 0.3, pointBackgroundColor: '#fff', 
                        pointBorderColor: '#334155', pointRadius: 5, fill: false, order: 1,
                        shadowColor: 'rgba(0, 0, 0, 0.3)', shadowBlur: 10, shadowOffsetY: 5
                    }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x:{grid:{display:false}}, y:{border:{display:false}, grid:{color:'#f1f5f9'}, ticks:{callback:v=>fmt(v)}, grace:'10%'} } }
        });

        const mc = document.getElementById('month-selector'); mc.innerHTML='';
        ms.forEach(m => {
            const isActive = activeMonths.size===0 || activeMonths.has(m);
            mc.innerHTML+=`<button onclick="toggleMonth('${m}')" class="month-btn px-3 py-1 rounded-full text-xs font-bold ${isActive ? 'active' : 'bg-white text-slate-500'}">${m.split('-')[1]}æœˆ</button>`;
        });

        const tb = document.getElementById('report-table-body'); tb.innerHTML='';
        const allMs = Object.keys(yearlyData).sort();
        displayMs.forEach((m)=>{
            const d=yearlyData[m], t=d.mix+d.prd;
            const i = allMs.indexOf(m);
            let md=0, pd=0, td=0;
            if(i>0){ const p=yearlyData[allMs[i-1]]; md=d.mix-p.mix; pd=d.prd-p.prd; td=t-(p.mix+p.prd); }
            tb.innerHTML+=`<tr class="hover:bg-indigo-50/30 transition border-b border-slate-50"><td class="px-6 py-4 font-bold text-left text-slate-700">${m} ${d.man?'<span class="text-[9px] bg-slate-200 text-slate-500 px-1 rounded ml-1">æ‰‹å‹•</span>':''}</td><td class="px-6 py-4 text-slate-500 text-xs">${fmt(d.mix)}</td><td class="px-6 py-4 text-slate-500 text-xs">${fmt(d.prd)}</td><td class="px-6 py-4 text-xs ${getDiffClass(md)}">${i===0?'-':fmtDiff(md)}</td><td class="px-6 py-4 text-xs ${getDiffClass(pd)}">${i===0?'-':fmtDiff(pd)}</td><td class="px-6 py-4 font-bold text-slate-800 text-sm bg-indigo-50/50">${fmt(t)}</td><td class="px-6 py-4 text-xs ${getDiffClass(td)}">${i===0?'-':fmtDiff(td)}</td><td class="px-6 py-4 text-center"><button class="px-3 py-1 text-xs font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-full transition" onclick="openModal('${m}')">æŸ¥çœ‹</button></td></tr>`;
        });

        updatePieCharts(displayMs);
    };

    const toggleMonth = (m) => { if(activeMonths.has(m)) activeMonths.delete(m); else activeMonths.add(m); renderDashboard(); };

    // --- NEW: Pie Charts Function ---
    const updatePieCharts = (displayMs) => {
        let serviceMap = {};
        let mixTotal = 0;
        let prdTotal = 0;

        displayMs.forEach(m => {
            [...yearlyData[m].mixI, ...yearlyData[m].prdI].forEach(item => {
                serviceMap[item.s] = (serviceMap[item.s] || 0) + item.c;
            });
            mixTotal += yearlyData[m].mix;
            prdTotal += yearlyData[m].prd;
        });

        // Service Chart Data Prep
        const sortedSvcs = Object.entries(serviceMap).sort((a, b) => b[1] - a[1]);
        const top5 = sortedSvcs.slice(0, 5);
        const others = sortedSvcs.slice(5).reduce((acc, curr) => acc + curr[1], 0);
        
        const svcLabels = top5.map(s => s[0].replace('Amazon', ''));
        const svcData = top5.map(s => s[1]);
        if(others > 0) { svcLabels.push('Others'); svcData.push(others); }

        // Render Service Pie
        const ctxSvc = document.getElementById('servicePieChart').getContext('2d');
        if(charts.svcPie) charts.svcPie.destroy();
        charts.svcPie = new Chart(ctxSvc, {
            type: 'doughnut',
            data: {
                labels: svcLabels,
                datasets: [{
                    data: svcData,
                    backgroundColor: ['#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#f59e0b', '#cbd5e1'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 11 } } } } 
            }
        });

        // Render Env Pie
        const ctxEnv = document.getElementById('envPieChart').getContext('2d');
        if(charts.envPie) charts.envPie.destroy();
        charts.envPie = new Chart(ctxEnv, {
            type: 'doughnut',
            data: {
                labels: ['MIX (æ¸¬è©¦)', 'PRD (æ­£å¼)'],
                datasets: [{
                    data: [mixTotal, prdTotal],
                    backgroundColor: ['#a5b4fc', '#7c3aed'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false,
                cutout: '60%',
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } } 
            }
        });
    };

    const openModal = (m) => {
        document.getElementById('detail-modal').classList.remove('hidden'); document.getElementById('modal-title').innerText = `${m} è©³ç´°åˆ†æ`;
        const d = yearlyData[m], all = [...d.mixI.map(i=>({...i,e:'MIX'})), ...d.prdI.map(i=>({...i,e:'PRD'}))];
        const area = document.getElementById('modal-content-area');
        area.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4"><div class="border border-slate-100 rounded-2xl p-4 shadow-sm"><h4 class="text-center text-xs font-bold text-slate-500 mb-2 uppercase">ç’°å¢ƒè²»ç”¨ä½”æ¯”</h4><div class="h-48"><canvas id="modEnv"></canvas></div></div><div class="border border-slate-100 rounded-2xl p-4 shadow-sm"><h4 class="text-center text-xs font-bold text-slate-500 mb-2 uppercase">å‰ 5 å¤§é«˜æˆæœ¬æœå‹™ (USD)</h4><div class="h-48"><canvas id="modSvc"></canvas></div></div></div><div class="bg-slate-50 rounded-xl border border-slate-100 overflow-hidden"><table class="w-full text-xs text-left"><thead class="bg-indigo-50 text-indigo-900 font-bold"><tr><th class="p-3">ç’°å¢ƒ</th><th class="p-3">æœå‹™</th><th class="p-3">ç´°é …</th><th class="p-3 text-right">è²»ç”¨ (USD)</th></tr></thead><tbody class="divide-y divide-slate-100">${all.sort((a,b)=>b.c-a.c).slice(0,10).map(i=>`<tr class="hover:bg-white transition"><td class="p-3"><span class="px-2 py-0.5 rounded-md font-bold text-[10px] ${i.e==='PRD'?'bg-purple-100 text-purple-700':'bg-blue-100 text-blue-700'}">${i.e}</span></td><td class="p-3 font-bold text-slate-700">${i.s.replace('Amazon','')}</td><td class="p-3 text-slate-500 truncate max-w-[200px]" title="${i.t}">${i.t}</td><td class="p-3 text-right font-mono font-bold text-slate-700">${fmtUSD(i.c)}</td></tr>`).join('')}</tbody></table></div>`;
        new Chart(document.getElementById('modEnv'), { type:'doughnut', data:{labels:['MIX','PRD'], datasets:[{data:[d.mix, d.prd], backgroundColor:['#a5b4fc','#7c3aed'], borderWidth:0}]}, options:{cutout:'75%', plugins:{legend:{position:'bottom'}}} });
        const sMap={}; all.forEach(i=>{ sMap[i.s]=(sMap[i.s]||0)+i.c }); const topS=Object.entries(sMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
        new Chart(document.getElementById('modSvc'), { type:'bar', data:{labels:topS.map(s=>s[0].replace('Amazon','')), datasets:[{label:'USD',data:topS.map(s=>s[1]), backgroundColor:'#8b5cf6', borderRadius:4}]}, options:{indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{display:false}}} });
    };

    // --- Detail View ---
    const updateDTOptions = () => {
        const ms = Object.keys(yearlyData).sort().reverse();
        const sel1 = document.getElementById('dt-month-curr');
        const sel2 = document.getElementById('dt-month-prev');
        const v1 = sel1.value; const v2 = sel2.value;
        sel1.innerHTML = ''; sel2.innerHTML = '';
        ms.forEach(m => { sel1.innerHTML+=`<option value="${m}">${m}</option>`; sel2.innerHTML+=`<option value="${m}">${m}</option>`; });
        if(ms.length>0) sel1.value = v1 || ms[0];
        if(ms.length>1) sel2.value = v2 || ms[1];
    };

    const renderDetailView = () => {
        const m1 = document.getElementById('dt-month-curr').value;
        const m2 = document.getElementById('dt-month-prev').value;
        const filterText = document.getElementById('dt-search').value.toLowerCase();
        if (!m1 || !m2) return;

        const d1 = yearlyData[m1], d2 = yearlyData[m2];
        const items1 = [...d1.mixI.map(i=>({...i,e:'MIX'})), ...d1.prdI.map(i=>({...i,e:'PRD'}))];
        const items2 = [...d2.mixI.map(i=>({...i,e:'MIX'})), ...d2.prdI.map(i=>({...i,e:'PRD'}))];
        
        const map = {};
        const getKey = (i) => `${i.e}|${i.s}|${i.t}`;
        items1.forEach(i => { const k=getKey(i); if(!map[k]) map[k]={e:i.e,s:i.s,t:i.t,c1:0,c2:0,u1:0,u2:0}; map[k].c1+=i.c; map[k].u1+=i.u; });
        items2.forEach(i => { const k=getKey(i); if(!map[k]) map[k]={e:i.e,s:i.s,t:i.t,c1:0,c2:0,u1:0,u2:0}; map[k].c2+=i.c; map[k].u2+=i.u; });
        
        let rows = Object.values(map).filter(r => {
            if(r.c1===0 && r.c2===0) return false;
            if(filterText) return r.s.toLowerCase().includes(filterText) || r.t.toLowerCase().includes(filterText) || r.e.toLowerCase().includes(filterText);
            return true;
        });
        
        let inc=0, dec=0;
        rows.forEach(r => { r.diff=r.c1-r.c2; r.uDiff=r.u1-r.u2; if(r.diff>0) inc+=r.diff; else dec+=Math.abs(r.diff); });
        document.getElementById('dt-stat-inc').innerText = `å¢åŠ : ${fmtUSD(inc)}`;
        document.getElementById('dt-stat-dec').innerText = `æ¸›å°‘: ${fmtUSD(dec)}`;
        document.getElementById('dt-footer').innerText = `å…± ${rows.length} ç­†è³‡æ–™`;

        rows.sort((a,b) => { if(dtSort==='usage') return Math.abs(b.uDiff) - Math.abs(a.uDiff); return b.diff - a.diff; });
        
        const tb = document.getElementById('dt-table-body'); tb.innerHTML = '';
        rows.slice(0, 500).forEach(r => {
            const diffClass = r.diff > 0.5 ? 'trend-up' : (r.diff < -0.5 ? 'trend-down' : 'text-slate-400');
            const diffSign = r.diff > 0 ? '+' : '';
            const uClass = r.uDiff > 0 ? 'text-red-600 font-bold' : (r.uDiff < 0 ? 'text-green-600 font-bold' : 'text-slate-400');
            tb.innerHTML += `<tr class="hover:bg-slate-50 transition"><td class="py-3 px-3"><span class="px-2 py-0.5 rounded text-[10px] font-bold ${r.e==='PRD'?'bg-purple-100 text-purple-700':'bg-indigo-50 text-indigo-700'}">${r.e}</span></td><td class="font-bold text-slate-700">${r.s.replace('Amazon','')}</td><td class="text-xs text-slate-500 truncate max-w-[250px]" title="${r.t}">${r.t}</td><td class="text-right text-xs ${uClass}">${r.uDiff.toLocaleString('en-US', {maximumFractionDigits: 1})}</td><td class="text-right font-mono text-slate-700">${fmtUSD(r.c1)}</td><td class="text-right font-mono text-slate-400 text-xs">${fmtUSD(r.c2)}</td><td class="text-right font-mono ${diffClass}">${diffSign}${fmtUSD(r.diff)}</td><td class="text-right text-xs text-slate-500">${fmtPct(r.c1, r.c2)}</td></tr>`;
        });
    };

    const dz=document.getElementById('drop-zone'); dz.ondragover=e=>{e.preventDefault();dz.classList.add('active');}; dz.ondragleave=()=>dz.classList.remove('active'); dz.ondrop=e=>{e.preventDefault();dz.classList.remove('active');handleFiles(e.dataTransfer.files);}; document.getElementById('fileInput').onchange=e=>handleFiles(e.target.files);
</script>
</body>
</html>